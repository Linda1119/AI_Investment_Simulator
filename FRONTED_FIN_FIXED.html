<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI íˆ¬ì ì‹œë®¬ë ˆì´í„° (ì‹¤ì œ ë°ì´í„°)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .stat-card h3 { font-size: 0.9em; opacity: 0.8; margin-bottom: 8px; }
        .stat-card .value { font-size: 2em; font-weight: bold; }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 1000;
        }
        .connection-status.connected { background: rgba(16,185,129,0.8); }
        .connection-status.disconnected { background: rgba(239,68,68,0.8); }
        
        /* ê±°ë˜ ëª¨ë‹¬ - ì‹¤ì œ ì•± ìŠ¤íƒ€ì¼ */
        .trade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: flex-end;
            justify-content: center;
        }
        .trade-modal.show { display: flex; }
        .modal-content {
            background: #1a1a1a;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 600px;
            color: white;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.2em; font-weight: 600; }
        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.8em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }
        .modal-body { padding: 20px; }
        
        /* ê°€ê²© íƒ­ */
        .price-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .price-tab {
            flex: 1;
            padding: 15px 10px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #888;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s;
        }
        .price-tab.active {
            color: white;
            border-bottom-color: white;
        }
        
        /* ê°€ê²© ì •ë³´ ì„¹ì…˜ */
        .price-display {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .price-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .price-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .price-adjust-btn {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .price-adjust-btn:active {
            background: rgba(255,255,255,0.2);
        }
        .price-input-container {
            flex: 1;
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
        }
        .price-input {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-align: right;
            outline: none;
            width: auto;
            min-width: 100px;
        }
        .price-input::-webkit-inner-spin-button,
        .price-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .price-unit {
            font-size: 2em;
            font-weight: bold;
            color: white;
        }
        
        /* í˜¸ê°€ì°½ ëª¨ë‹¬ */
        .quote-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .quote-modal.show { display: flex; }
        .quote-content {
            background: #1a1a1a;
            border-radius: 20px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            color: white;
        }
        .quote-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quote-info {
            padding: 15px 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .quote-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .quote-info-row:last-child { margin-bottom: 0; }
        .quote-table {
            padding: 0;
        }
        .quote-section-header {
            background: rgba(255,255,255,0.05);
            padding: 8px 15px;
            font-size: 0.85em;
            color: #888;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .quote-row {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            font-size: 0.9em;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .quote-row:hover {
            background: rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .quote-row-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .quote-row-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .quote-volume {
            min-width: 60px;
            text-align: right;
            font-size: 0.85em;
        }
        .quote-price {
            min-width: 100px;
            text-align: right;
            font-weight: bold;
            font-size: 1.05em;
        }
        .quote-usd {
            min-width: 70px;
            text-align: right;
            font-size: 0.8em;
            color: #666;
        }
        .quote-change {
            min-width: 60px;
            text-align: right;
            font-size: 0.85em;
        }
        .quote-sell .quote-price {
            color: #3b82f6;
        }
        .quote-sell .quote-change {
            color: #3b82f6;
        }
        .quote-buy .quote-price {
            color: #ef4444;
        }
        .quote-buy .quote-change {
            color: #ef4444;
        }
        .quote-current {
            background: rgba(255,255,255,0.08);
            font-weight: bold;
            padding: 12px 15px;
        }
        .quote-current .quote-price {
            color: white;
            font-size: 1.2em;
        }
        
        /* ê°€ê²© ë³€ë™ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes priceUp {
            0% { background-color: rgba(34, 197, 94, 0.3); transform: scale(1); }
            50% { background-color: rgba(34, 197, 94, 0.5); transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        
        @keyframes priceDown {
            0% { background-color: rgba(239, 68, 68, 0.3); transform: scale(1); }
            50% { background-color: rgba(239, 68, 68, 0.5); transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        
        .price-up {
            animation: priceUp 0.6s ease-out;
        }
        
        .price-down {
            animation: priceDown 0.6s ease-out;
        }
        
        /* ìˆ«ì ë³€í™” ë¶€ë“œëŸ½ê²Œ */
        .animated-number {
            transition: all 0.3s ease-out;
        }
        
        /* ê¸°ê°„ ì„ íƒ íƒ­ */
        .period-tab {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #888;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .period-tab:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
            color: #fff;
        }
        
        .period-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        
        /* ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #1a1a1a;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 4000;
            display: none;
            min-width: 300px;
            text-align: center;
        }
        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        .toast-message {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-line;
        }
        .toast-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
        }
        .toast-btn:active {
            background: #2563eb;
        }
        .toast-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 3999;
            display: none;
        }
        .toast-overlay.show {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .price-main {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .price-usd {
            color: #888;
            font-size: 0.95em;
        }
        .price-note {
            color: #888;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        /* ìˆ˜ëŸ‰ ì„¹ì…˜ */
        .quantity-section {
            margin-bottom: 25px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .section-label {
            color: #ccc;
            font-size: 0.95em;
        }
        .available-label {
            color: #888;
            font-size: 0.85em;
        }
        .quantity-input-area {
            background: rgba(255,255,255,0.05);
            padding: 18px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .quantity-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            font-weight: bold;
            text-align: right;
            outline: none;
        }
        .quantity-unit {
            color: #888;
            font-size: 1.1em;
        }
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .quick-btn {
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        .quick-btn:active {
            background: rgba(255,255,255,0.15);
        }
        
        /* ì´ ê¸ˆì•¡ ì„¹ì…˜ */
        .total-section {
            background: rgba(255,255,255,0.05);
            padding: 18px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .total-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .total-amount {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }
        
        /* í•˜ë‹¨ ë²„íŠ¼ */
        .modal-actions {
            display: flex;
            gap: 10px;
            padding: 20px;
            padding-top: 0;
        }
        .action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cancel-btn {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .confirm-btn {
            background: #ef4444;
            color: white;
        }
        .confirm-btn.sell {
            background: #3b82f6;
        }
        
        .ai-recommendation {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid;
            display: none;
        }
        .ai-recommendation.show { display: block; }
        .ai-recommendation.buy { border-color: #10b981; background: rgba(16,185,129,0.15); }
        .ai-recommendation.sell { border-color: #ef4444; background: rgba(239,68,68,0.15); }
        .ai-recommendation.hold { border-color: #6b7280; background: rgba(107,114,128,0.15); }
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .badge-action {
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
        }
        .badge-action.buy { background: #10b981; }
        .badge-action.sell { background: #ef4444; }
        .badge-action.hold { background: #6b7280; }
        .rec-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .rec-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }
        .rec-box h4 { margin-bottom: 15px; font-size: 1.1em; }
        .rec-item { margin-bottom: 12px; }
        .rec-item label { opacity: 0.7; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .rec-item .value { font-size: 1.4em; font-weight: bold; }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        select, button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
        }
        select {
            background: rgba(255,255,255,0.2);
            color: white;
            min-width: 250px;
        }
        select option { background: #1e3c72; color: white; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1); }
        button.buy { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        button.sell { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        button.ai-execute {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            width: 100%;
            margin-top: 10px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        .chart-container {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        canvas {
            width: 100% !important;
            height: 350px !important;
            border-radius: 10px;
        }
        .trades {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
        }
        .trade-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .trade-item.buy { border-left: 4px solid #10b981; }
        .trade-item.sell { border-left: 4px solid #ef4444; }
        .progress {
            width: 100%;
            height: 35px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        .info-box {
            background: linear-gradient(135deg, rgba(251,191,36,0.2) 0%, rgba(245,158,11,0.2) 100%);
            border: 2px solid rgba(251,191,36,0.4);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        .info-box h3 { margin-bottom: 12px; color: #fbbf24; }
        .info-box ul { list-style: none; }
        .info-box li { margin-bottom: 8px; padding-left: 20px; position: relative; }
        .info-box li:before { content: "ğŸ’¡"; position: absolute; left: 0; }
        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }
        .error-message {
            background: rgba(239,68,68,0.2);
            border: 2px solid #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .stock-info {
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .stock-info div { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        ğŸ”„ ì„œë²„ ì—°ê²° ì¤‘...
    </div>

    <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ -->
    <div class="toast-overlay" id="toastOverlay" onclick="closeToast()"></div>
    <div class="toast" id="toast">
        <div class="toast-message" id="toastMessage"></div>
        <button class="toast-btn" onclick="closeToast()">í™•ì¸</button>
    </div>

    <!-- í˜¸ê°€ì°½ ëª¨ë‹¬ -->
    <div class="quote-modal" id="quoteModal">
        <div class="quote-content">
            <div class="quote-header">
                <h2>í˜¸ê°€</h2>
                <button class="close-btn" onclick="closeQuoteModal()">Ã—</button>
            </div>
            <div class="quote-info">
                <div class="quote-info-row">
                    <span style="color:#888;">52ì£¼ ìµœê³ </span>
                    <span id="week52High">-</span>
                </div>
                <div class="quote-info-row">
                    <span style="color:#888;">52ì£¼ ìµœì €</span>
                    <span id="week52Low">-</span>
                </div>
                <div class="quote-info-row">
                    <span style="color:#888;">ê±°ë˜ëŸ‰</span>
                    <span id="volume">-</span>
                </div>
            </div>
            <div class="quote-table">
                <div class="quote-section-header">ë§¤ë„ í˜¸ê°€</div>
                <div id="sellQuotes"></div>
                
                <div class="quote-current" id="currentQuote">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.9em; color:#888;">í˜„ì¬ê°€</span>
                        <div style="text-align:right;">
                            <div class="quote-price">0ì›</div>
                            <div style="font-size:0.85em; color:#888; margin-top:3px;">$0.00</div>
                        </div>
                    </div>
                </div>
                
                <div class="quote-section-header">ë§¤ìˆ˜ í˜¸ê°€</div>
                <div id="buyQuotes"></div>
            </div>
        </div>
    </div>

    <!-- ê±°ë˜ ëª¨ë‹¬ -->
    <div class="trade-modal" id="tradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ë§¤ìˆ˜</h2>
                <button class="close-btn" onclick="closeTradeModal()">Ã—</button>
            </div>
            
            <div class="modal-body">
                <!-- ê°€ê²© íƒ€ì… íƒ­ -->
                <div class="price-tabs">
                    <button class="price-tab active" data-type="limit" onclick="switchPriceTab('limit')">êµ¬ë§¤í•  ê°€ê²©</button>
                    <button class="price-tab" data-type="current" onclick="switchPriceTab('current')">í˜„ì¬ê°€</button>
                    <button class="price-tab" data-type="market" onclick="switchPriceTab('market')">ì‹œì¥ê°€</button>
                </div>
                
                <!-- ê°€ê²© í‘œì‹œ ì˜ì—­ -->
                <div class="price-display" id="priceDisplay">
                    <!-- êµ¬ë§¤í•  ê°€ê²© íƒ­ ë‚´ìš© -->
                    <div id="limitPriceContent">
                        <div class="price-label">êµ¬ë§¤í•  ê°€ê²©</div>
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: baseline; margin-bottom: 5px; min-height: 60px;">
                                    <input type="text" 
                                           id="limitPriceInput" 
                                           style="background: none; border: none; color: white; font-size: 2.5em; font-weight: bold; outline: none; flex-shrink: 1; min-width: 0;"
                                           value="0"
                                           oninput="formatPriceInput(this)"
                                           onblur="updateLimitPrice()">
                                    <span style="font-size: 2.5em; font-weight: bold; margin-left: 4px; white-space: nowrap;">ì›</span>
                                </div>
                                <div class="price-usd" id="limitPriceUSD" style="font-size: 0.95em; color: #888; min-height: 22px;">$0.00</div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-shrink: 0;">
                                <button class="price-adjust-btn" onclick="adjustPrice(-1)">âˆ’</button>
                                <button class="price-adjust-btn" onclick="adjustPrice(1)">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í˜„ì¬ê°€ íƒ­ ë‚´ìš© -->
                    <div id="currentPriceContent" style="display:none;">
                        <div class="price-label">í˜„ì¬ê°€</div>
                        <div style="min-height: 60px; display: flex; align-items: center;">
                            <div class="price-main" id="currentPriceKRW" style="font-size: 2.5em; font-weight: bold;">ì•½ 0ì›</div>
                        </div>
                        <div class="price-usd" id="currentPriceUSD" style="min-height: 22px; font-size: 0.95em; color: #888;">$0.00</div>
                    </div>
                    
                    <!-- ì‹œì¥ê°€ íƒ­ ë‚´ìš© -->
                    <div id="marketPriceContent" style="display:none;">
                        <div class="price-label">ì‹œì¥ê°€</div>
                        <div style="min-height: 60px; display: flex; align-items: center;">
                            <div class="price-main" style="font-size: 2.5em; font-weight: bold;">ìµœëŒ€í•œ ë¹ ë¥¸ ê°€ê²©</div>
                        </div>
                        <div class="price-note" style="min-height: 22px;">ì²´ê²° ê°€ëŠ¥í•œ ê°€ê²©ìœ¼ë¡œ ì£¼ë¬¸ë©ë‹ˆë‹¤</div>
                    </div>
                </div>
                
                <!-- ìˆ˜ëŸ‰ ì…ë ¥ -->
                <div class="quantity-section">
                    <div class="section-header">
                        <div class="section-label">ìˆ˜ëŸ‰</div>
                        <div class="available-label" id="availableInfo">0ì£¼</div>
                    </div>
                    <div class="quantity-input-area">
                        <input type="number" 
                               id="quantityInput" 
                               class="quantity-input" 
                               value="0" 
                               min="0"
                               oninput="updateTotalAmount()">
                        <span class="quantity-unit">ì£¼</span>
                    </div>
                    <div class="quick-buttons">
                        <button class="quick-btn" onclick="setQuickQuantity(10)">10%</button>
                        <button class="quick-btn" onclick="setQuickQuantity(25)">25%</button>
                        <button class="quick-btn" onclick="setQuickQuantity(50)">50%</button>
                        <button class="quick-btn" onclick="setQuickQuantity(100)">ìµœëŒ€</button>
                    </div>
                </div>
                
                <!-- ìŠ¤íƒ‘ë¡œìŠ¤ ì„¤ì • (ë§¤ìˆ˜ì¼ ë•Œë§Œ í‘œì‹œ) -->
                <div id="stopLossSection" style="margin-top: 20px; display: none;">
                    <div class="section-header">
                        <div class="section-label">ğŸ›‘ ìŠ¤íƒ‘ë¡œìŠ¤ (ì†ì ˆê°€)</div>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                            <input type="checkbox" id="enableStopLoss" onchange="toggleStopLoss()" style="width: 18px; height: 18px;">
                            <span>í™œì„±í™”</span>
                        </label>
                    </div>
                    <div id="stopLossInputArea" style="display: none;">
                        <!-- ë°©ì‹ ì„ íƒ -->
                        <div style="display: flex; gap: 15px; margin-top: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="stopLossType" value="percent" checked onchange="switchStopLossType()" style="width: 16px; height: 16px;">
                                <span style="font-size: 0.95em;">ë¹„ìœ¨ë¡œ ì„¤ì •</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="stopLossType" value="price" onchange="switchStopLossType()" style="width: 16px; height: 16px;">
                                <span style="font-size: 0.95em;">ê°€ê²©ìœ¼ë¡œ ì„¤ì •</span>
                            </label>
                        </div>
                        
                        <!-- ë¹„ìœ¨ ë°©ì‹ -->
                        <div id="stopLossPercentMode">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <input type="number" 
                                           id="stopLossPercent" 
                                           class="quantity-input" 
                                           value="10" 
                                           min="1"
                                           max="50"
                                           style="width: 100%;"
                                           oninput="updateStopLossPriceFromPercent()">
                                    <div style="text-align: center; font-size: 0.85em; color: #888; margin-top: 5px;">ì†ì‹¤ë¥  (%)</div>
                                </div>
                                <div style="flex: 1;">
                                    <input type="text" 
                                           id="stopLossPriceDisplay" 
                                           class="quantity-input" 
                                           value="0"
                                           readonly
                                           style="width: 100%; background: rgba(255,255,255,0.05);">
                                    <div style="text-align: center; font-size: 0.85em; color: #888; margin-top: 5px;">ì†ì ˆê°€</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ê°€ê²© ë°©ì‹ -->
                        <div id="stopLossPriceMode" style="display: none;">
                            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                <div style="text-align: center; font-size: 2em; font-weight: bold;">
                                    <input type="text" 
                                           id="stopLossPriceInput" 
                                           class="quantity-input" 
                                           value="0 ì›"
                                           placeholder="ê°€ê²© ì…ë ¥"
                                           style="width: 250px; font-size: 1em; text-align: center; padding: 0; border: none; background: transparent;"
                                           oninput="formatStopLossPriceInput(this); updateStopLossPercentFromPrice()"
                                           onclick="moveStopLossCursor(this)"
                                           onfocus="selectStopLossNumber(this)">
                                </div>
                                <div id="stopLossPriceUSD" style="text-align: center; font-size: 0.95em; color: #888; margin-top: 5px; display: none;"></div>
                            </div>
                            <div style="text-align: center; font-size: 0.9em; color: #888; margin-top: 8px;">
                                ì†ì‹¤ë¥ : <span id="stopLossPercentDisplay">0%</span>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #f59e0b; margin-top: 10px; padding: 10px; background: rgba(245,158,11,0.1); border-radius: 8px;">
                            ğŸ’¡ ì„¤ì •í•œ ê°€ê²© ì´í•˜ë¡œ ë–¨ì–´ì§€ë©´ ìë™ìœ¼ë¡œ ì „ëŸ‰ ë§¤ë„ë©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>
                
                <!-- ì´ ê¸ˆì•¡ -->
                <div class="total-section">
                    <div class="total-label">ì´</div>
                    <div class="total-amount" id="totalAmount">â‚©0</div>
                </div>
            </div>
            
            <!-- í•˜ë‹¨ ë²„íŠ¼ -->
            <div class="modal-actions">
                <button class="action-btn confirm-btn" id="confirmBtn" onclick="confirmTrade()" style="width: 100%;">êµ¬ë§¤í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>
                ğŸ¤– AI íˆ¬ì ì‹œë®¬ë ˆì´í„°
                <span class="badge">âœ… ì‹¤ì œ ë°ì´í„°</span>
            </h1>
            <p>ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ LSTM ë”¥ëŸ¬ë‹ íˆ¬ì ì‹œìŠ¤í…œ</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="stats">
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3>ğŸ’° í¬íŠ¸í´ë¦¬ì˜¤</h3>
                <div class="value" id="portfolio">$3,000</div>
                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;" id="portfolioKRW">â‚©4,410,000</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <h3>ğŸ’µ í˜„ê¸ˆ</h3>
                <div class="value" id="cash">$3,000</div>
                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;" id="cashKRW">â‚©4,410,000</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <h3>ğŸ“Š ë³´ìœ ì£¼ì‹</h3>
                <div class="value" id="shares">0ì£¼</div>
            </div>
            <div class="stat-card" id="returnCard" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3>ğŸ“ˆ ìˆ˜ìµë¥ </h3>
                <div class="value" id="return">0%</div>
            </div>
        </div>

        <div id="aiRecommendation" class="ai-recommendation"></div>

        <div class="controls">
            <h2 style="margin-bottom: 15px;">âš™ï¸ ì»¨íŠ¸ë¡¤ íŒ¨ë„</h2>
            
            <div class="stock-info" id="stockInfo" style="display:none;">
                <div><strong>ì¢…ëª©ëª…:</strong> <span id="stockName">-</span></div>
                <div><strong>ì„¹í„°:</strong> <span id="stockSector">-</span></div>
                <div><strong>ê±°ë˜ì†Œ:</strong> <span id="stockExchange">-</span></div>
            </div>

            <div class="control-group">
                <select id="stockSelect">
                    <optgroup label="ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì£¼ì‹">
                        <option value="AAPL">Apple (AAPL)</option>
                        <option value="GOOGL">Google (GOOGL)</option>
                        <option value="TSLA">Tesla (TSLA)</option>
                        <option value="MSFT">Microsoft (MSFT)</option>
                        <option value="AMZN">Amazon (AMZN)</option>
                        <option value="META">Meta (META)</option>
                        <option value="NVDA">NVIDIA (NVDA)</option>
                    </optgroup>
                    <optgroup label="ğŸ‡°ğŸ‡· í•œêµ­ ì£¼ì‹">
                        <option value="005930.KS">ì‚¼ì„±ì „ì (005930.KS)</option>
                        <option value="000660.KS">SKí•˜ì´ë‹‰ìŠ¤ (000660.KS)</option>
                        <option value="005380.KS">í˜„ëŒ€ìë™ì°¨ (005380.KS)</option>
                        <option value="035420.KS">NAVER (035420.KS)</option>
                        <option value="035720.KS">ì¹´ì¹´ì˜¤ (035720.KS)</option>
                        <option value="006400.KS">ì‚¼ì„±SDI (006400.KS)</option>
                        <option value="051910.KS">LGí™”í•™ (051910.KS)</option>
                        <option value="207940.KS">ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤ (207940.KS)</option>
                    </optgroup>
                </select>
                <button onclick="loadStockData()" id="loadBtn">ğŸ“¥ ë°ì´í„° ë¡œë“œ</button>
                <button onclick="trainAI()" id="trainBtn" disabled>ğŸ§  AI í•™ìŠµ ì‹œì‘</button>
                <button class="buy" onclick="openTradeModal('buy')" disabled id="buyBtn">ğŸ“ˆ ë§¤ìˆ˜</button>
                <button class="sell" onclick="openTradeModal('sell')" disabled id="sellBtn">ğŸ“‰ ë§¤ë„</button>
            </div>
            <div id="progressBar" style="display:none;" class="progress">
                <div class="progress-bar" id="progress">0%</div>
            </div>
        </div>

        <div class="main-grid">
            <div>
                <div class="chart-container">
                    <h2 style="margin-bottom: 15px;">ğŸ“ˆ ì‹¤ì œ ì£¼ê°€ ì°¨íŠ¸</h2>
                    
                    <!-- ê¸°ê°„ ì„ íƒ íƒ­ -->
                    <div id="periodTabs" style="display: none; margin-bottom: 15px; gap: 5px; flex-wrap: wrap;">
                        <button class="period-tab active" data-period="1D" onclick="changePeriod('1D')">ì‹¤ì‹œê°„</button>
                        <button class="period-tab" data-period="1W" onclick="changePeriod('1W')">1ì£¼</button>
                        <button class="period-tab" data-period="3M" onclick="changePeriod('3M')">3ë‹¬</button>
                        <button class="period-tab" data-period="1Y" onclick="changePeriod('1Y')">1ë…„</button>
                        <button class="period-tab" data-period="3Y" onclick="changePeriod('3Y')">3ë…„</button>
                    </div>
                    
                    <div id="chartLoading" class="loading">
                        <p>ì¢…ëª©ì„ ì„ íƒí•˜ê³  "ë°ì´í„° ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                    <canvas id="chart" style="display:none;"></canvas>
                    <div id="chartPriceDisplay" style="display: none; margin-top: 20px; text-align: center;">
                        <span style="font-size: 2em; font-weight: bold;" id="currentPrice"></span>
                        <span style="font-size: 1.2em; opacity: 0.7; margin-left: 10px;" id="stockSymbol"></span>
                    </div>
                    
                    <!-- ì°¨íŠ¸ í•˜ë‹¨ ì •ë³´ -->
                    <div id="chartInfo" style="display: none; margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <h3 id="chartInfoHeader" style="margin-bottom: 15px; font-size: 1.1em; text-align: center;">ğŸ“Š ê±°ë˜ ì •ë³´</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <div>
                                <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">ğŸ“Š ì‹œê°€</div>
                                <div id="chartOpen" style="font-size: 1.2em; font-weight: bold;">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">ğŸ“ˆ ê³ ê°€</div>
                                <div id="chartHigh" style="font-size: 1.2em; font-weight: bold; color: #22c55e;">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">ğŸ“‰ ì €ê°€</div>
                                <div id="chartLow" style="font-size: 1.2em; font-weight: bold; color: #ef4444;">-</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; color: #888; margin-bottom: 5px;">ğŸ’¹ ê±°ë˜ëŸ‰</div>
                                <div id="chartVolume" style="font-size: 1.2em; font-weight: bold;">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container" id="predictionChart" style="display:none;">
                    <h2 style="margin-bottom: 15px;">ğŸ”® AI ì˜ˆì¸¡ ì°¨íŠ¸ (30ì¼)</h2>
                    <canvas id="predChart"></canvas>
                </div>
            </div>

            <div>
                <div class="trades">
                    <h2 style="margin-bottom: 15px;">ğŸ“œ ê±°ë˜ ë‚´ì—­</h2>
                    <div id="tradeList">
                        <p style="text-align: center; opacity: 0.7; padding: 40px 20px;">
                            ì•„ì§ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤<br>
                            <small>ë§¤ìˆ˜/ë§¤ë„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê±°ë˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”</small>
                        </p>
                    </div>
                </div>

                <div class="info-box">
                    <h3>ğŸ’¡ ì‹¤ì œ ë°ì´í„° ì •ë³´</h3>
                    <ul>
                        <li>ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ API ì‚¬ìš©</li>
                        <li>ìµœê·¼ 100ì¼ ì‹¤ì œ ì£¼ê°€</li>
                        <li>RSI, ì´ë™í‰ê· ì„  ê³„ì‚°</li>
                        <li>ë°±ì—”ë“œ ì„œë²„ í•„ìš”</li>
                    </ul>
                </div>
            </div>
        </div>

        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; opacity: 0.8;">
            <small>âš ï¸ ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ì´ì§€ë§Œ êµìœ¡ ëª©ì ì˜ ì‹œë®¬ë ˆì´í„°ì…ë‹ˆë‹¤. ì‹¤ì œ íˆ¬ìì™€ ë¬´ê´€í•©ë‹ˆë‹¤.</small>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000';
        const USD_TO_KRW = 1470; // í™˜ìœ¨: $1 = â‚©1,470
        
        // ì»¤ìŠ¤í…€ ì•Œë¦¼ í•¨ìˆ˜
        function showToast(message) {
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toast').classList.add('show');
            document.getElementById('toastOverlay').classList.add('show');
        }
        
        function closeToast() {
            document.getElementById('toast').classList.remove('show');
            document.getElementById('toastOverlay').classList.remove('show');
        }
        
        let portfolio = { cash: 3000, shares: 0, value: 3000, stopLoss: null, buyPrice: null };
        let currentStock = 'AAPL';
        let stockData = [];
        let predictionData = [];
        let trades = [];
        let aiRecommendation = null;
        let lstmModel = null;
        let normalizeParams = { min: 0, max: 0 };
        let currentTradeType = 'buy';
        let currentPriceType = 'limit';
        let currentPeriod = '1Y'; // í˜„ì¬ ì„ íƒëœ ê¸°ê°„
        let realtimePrice = 0; // ì‹¤ì‹œê°„ ê°€ê²© (íƒ­ê³¼ ë¬´ê´€)
        let allStockData = {}; // ëª¨ë“  ê¸°ê°„ ë°ì´í„° ì €ì¥

        // ì„œë²„ ì—°ê²° í™•ì¸
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    document.getElementById('connectionStatus').textContent = 'âœ… ì„œë²„ ì—°ê²°ë¨';
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    return true;
                }
            } catch (error) {
                document.getElementById('connectionStatus').textContent = 'âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                showError('ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Python ì„œë²„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return false;
            }
        }

        // ì‹¤ì œ ì£¼ê°€ ë°ì´í„° ë¡œë“œ
        let priceUpdateInterval = null;
        let currentAnimatedPrice = null;
        
        // ê¸°ê°„ ë³€ê²½
        async function changePeriod(period) {
            currentPeriod = period;
            
            // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.period === period) {
                    tab.classList.add('active');
                }
            });
            
            // í•´ë‹¹ ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë“œ
            if (!allStockData[period]) {
                await loadPeriodData(period);
            } else {
                // ìºì‹œëœ ì›ë³¸ ë°ì´í„°ì˜ ê¹Šì€ ë³µì‚¬ë³¸ ì‚¬ìš©
                stockData = JSON.parse(JSON.stringify(allStockData[period]));
                drawChart();
                updateChartInfo();
            }
        }
        
        // íŠ¹ì • ê¸°ê°„ ë°ì´í„° ë¡œë“œ
        async function loadPeriodData(period) {
            try {
                const periodMap = {
                    '1D': '1d',
                    '1W': '5d',
                    '3M': '3mo',
                    '1Y': '1y',
                    '3Y': '3y'
                };
                
                // ì‹¤ì‹œê°„(1D)ì€ intervalë„ ì¶”ê°€
                let url = `${API_URL}/api/stock/${currentStock}?period=${periodMap[period]}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬
                if (!result.data || result.data.length === 0) {
                    throw new Error(`${period} ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤`);
                }
                
                // ë°ì´í„° ì €ì¥ (ì›ë³¸)
                allStockData[period] = result.data.map(d => ({
                    date: d.date,
                    price: d.price,
                    open: d.open,
                    high: d.high,
                    low: d.low,
                    volume: d.volume
                }));
                
                // ì‘ì—…ìš© ë³µì‚¬ë³¸ ìƒì„±
                stockData = JSON.parse(JSON.stringify(allStockData[period]));
                
                console.log(`${period} ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${stockData.length}ê°œ`);
                console.log(`ì²« ë‚ ì§œ: ${stockData[0].date}, ë§ˆì§€ë§‰ ë‚ ì§œ: ${stockData[stockData.length-1].date}`);
                console.log(`ê°€ê²© ë²”ìœ„: ${Math.min(...stockData.map(d => d.price)).toFixed(2)} ~ ${Math.max(...stockData.map(d => d.price)).toFixed(2)}`);
                
                // ë‚ ì§œ ì°¨ì´ ê³„ì‚°
                const firstDate = new Date(stockData[0].date);
                const lastDate = new Date(stockData[stockData.length-1].date);
                const daysDiff = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
                const monthsDiff = daysDiff / 30;
                const yearsDiff = daysDiff / 365;
                
                console.log(`ê¸°ê°„: ${daysDiff}ì¼ (ì•½ ${monthsDiff.toFixed(1)}ê°œì›” / ${yearsDiff.toFixed(1)}ë…„)`);
                
                drawChart();
                updateChartInfo();
                
            } catch (error) {
                console.error('Period data loading error:', error);
                showToast('âŒ ' + error.message);
            }
        }
        
        // ì°¨íŠ¸ í•˜ë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateChartInfo() {
            if (stockData.length === 0) return;
            
            console.log('=== ì°¨íŠ¸ ì •ë³´ ê³„ì‚° ===');
            console.log(`currentStock: "${currentStock}"`);
            console.log(`isKorean: ${isKorean(currentStock)}`);
            console.log(`ê¸°ê°„: ${currentPeriod}`);
            console.log(`ë°ì´í„° ê°œìˆ˜: ${stockData.length}ê°œ`);
            
            // ì „ì²´ ê¸°ê°„ì˜ ì‹œê°€/ê³ ê°€/ì €ê°€/ê±°ë˜ëŸ‰ ê³„ì‚°
            const firstData = stockData[0];
            const periodOpen = firstData.open;  // ê¸°ê°„ ì²«ë‚  ì‹œê°€
            
            let periodHigh = -Infinity;
            let periodLow = Infinity;
            let totalVolume = 0;
            
            let highDate = '';
            let lowDate = '';
            
            stockData.forEach(d => {
                if (d.high > periodHigh) {
                    periodHigh = d.high;
                    highDate = d.date;
                }
                if (d.low < periodLow) {
                    periodLow = d.low;
                    lowDate = d.date;
                }
                totalVolume += d.volume;
            });
            
            // ì‹¤ì‹œê°„ íƒ­ì€ ìµœì‹  ê±°ë˜ëŸ‰ë§Œ í‘œì‹œ (ì¤‘ë³µ í•©ì‚° ë°©ì§€)
            if (currentPeriod === '1D') {
                const latestData = stockData[stockData.length - 1];
                totalVolume = latestData.volume;
                console.log(`ì‹¤ì‹œê°„: ìµœì‹  ê±°ë˜ëŸ‰ë§Œ ì‚¬ìš©`);
            }
            
            console.log(`ì²«ë‚  (${firstData.date}): ì‹œê°€ $${periodOpen.toFixed(2)}`);
            console.log(`ìµœê³ ê°€: $${periodHigh.toFixed(2)} (${highDate})`);
            console.log(`ìµœì €ê°€: $${periodLow.toFixed(2)} (${lowDate})`);
            console.log(`ê±°ë˜ëŸ‰: ${totalVolume.toLocaleString()}`);
            
            // ê¸°ê°„ëª… í‘œì‹œ
            const periodNames = {
                '1D': 'ì˜¤ëŠ˜',
                '1W': '1ì£¼',
                '3M': '3ê°œì›”',
                '1Y': '1ë…„',
                '3Y': '3ë…„'
            };
            const periodName = periodNames[currentPeriod] || currentPeriod;
            
            if (isKorean(currentStock)) {
                document.getElementById('chartOpen').textContent = Math.round(periodOpen).toLocaleString() + 'ì›';
                document.getElementById('chartHigh').textContent = Math.round(periodHigh).toLocaleString() + 'ì›';
                document.getElementById('chartLow').textContent = Math.round(periodLow).toLocaleString() + 'ì›';
            } else {
                document.getElementById('chartOpen').textContent = '$' + periodOpen.toFixed(2);
                document.getElementById('chartHigh').textContent = '$' + periodHigh.toFixed(2);
                document.getElementById('chartLow').textContent = '$' + periodLow.toFixed(2);
            }
            
            document.getElementById('chartVolume').textContent = formatVolume(totalVolume);
            
            // ê¸°ê°„ ì •ë³´ í—¤ë” ì—…ë°ì´íŠ¸
            const infoHeader = document.getElementById('chartInfoHeader');
            if (infoHeader) {
                infoHeader.textContent = `ğŸ“Š ${periodName} ê±°ë˜ ì •ë³´`;
            }
            
            document.getElementById('chartInfo').style.display = 'block';
        }
        
        // ê±°ë˜ëŸ‰ í¬ë§·
        function formatVolume(volume) {
            if (volume >= 1000000000) {
                return (volume / 1000000000).toFixed(2) + 'B';
            } else if (volume >= 1000000) {
                return (volume / 1000000).toFixed(2) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(2) + 'K';
            }
            return volume.toLocaleString();
        }
        
        // ê°€ê²© ì¹´ìš´íŠ¸ì—… ì• ë‹ˆë©”ì´ì…˜
        function animatePrice(element, startPrice, endPrice, duration = 500) {
            const startTime = performance.now();
            const priceDiff = endPrice - startPrice;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // easeOutQuad íš¨ê³¼
                const easeProgress = 1 - (1 - progress) * (1 - progress);
                const currentPrice = startPrice + (priceDiff * easeProgress);
                
                element.textContent = currentPrice.toFixed(2);
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element.textContent = endPrice.toFixed(2);
                }
            }
            
            requestAnimationFrame(update);
        }
        
        // ê°€ê²© ë³€ë™ ê¹œë¹¡ì„ íš¨ê³¼
        function flashPriceChange(element, isIncrease) {
            element.style.transition = 'background-color 0.3s, color 0.3s';
            
            if (isIncrease) {
                element.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
                element.style.color = '#22c55e';
            } else {
                element.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
                element.style.color = '#ef4444';
            }
            
            setTimeout(() => {
                element.style.backgroundColor = '';
                element.style.color = '';
            }, 500);
        }
        
        // ìŠ¤íƒ‘ë¡œìŠ¤ í† ê¸€
        function toggleStopLoss() {
            const enabled = document.getElementById('enableStopLoss').checked;
            document.getElementById('stopLossInputArea').style.display = enabled ? 'block' : 'none';
            if (enabled) {
                switchStopLossType();
            }
        }
        
        // ìŠ¤íƒ‘ë¡œìŠ¤ íƒ€ì… ì „í™˜
        function switchStopLossType() {
            const type = document.querySelector('input[name="stopLossType"]:checked').value;
            
            if (type === 'percent') {
                document.getElementById('stopLossPercentMode').style.display = 'block';
                document.getElementById('stopLossPriceMode').style.display = 'none';
                updateStopLossPriceFromPercent();
            } else {
                document.getElementById('stopLossPercentMode').style.display = 'none';
                document.getElementById('stopLossPriceMode').style.display = 'block';
                
                // ì´ˆê¸°ê°’ ì„¤ì •
                const currentPrice = getCurrentBuyPrice();
                const initialStopLoss = Math.round(currentPrice * 0.9);
                document.getElementById('stopLossPriceInput').value = initialStopLoss.toLocaleString() + ' ì›';
                updateStopLossPercentFromPrice();
            }
        }
        
        // í˜„ì¬ ë§¤ìˆ˜ê°€ ê°€ì ¸ì˜¤ê¸°
        function getCurrentBuyPrice() {
            let currentPrice;
            
            if (currentPriceType === 'limit') {
                currentPrice = getPriceInputValue();
            } else {
                const price = stockData[stockData.length - 1].price;
                currentPrice = isKorean(currentStock) ? Math.round(price) : Math.round(price * USD_TO_KRW);
            }
            
            return currentPrice;
        }
        
        // ë¹„ìœ¨ë¡œ ê°€ê²© ê³„ì‚°
        function updateStopLossPriceFromPercent() {
            const percent = parseFloat(document.getElementById('stopLossPercent').value) || 10;
            const currentPrice = getCurrentBuyPrice();
            const stopLossPrice = Math.round(currentPrice * (1 - percent / 100));
            
            const displayPrice = isKorean(currentStock) ?
                stopLossPrice.toLocaleString() + 'ì›' :
                stopLossPrice.toLocaleString() + 'ì› ($' + (stopLossPrice / USD_TO_KRW).toFixed(2) + ')';
            
            document.getElementById('stopLossPriceDisplay').value = displayPrice;
        }
        
        // ê°€ê²© ì…ë ¥ í¬ë§·íŒ…
        function formatStopLossPriceInput(input) {
            // ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
            const cursorPos = input.selectionStart;
            const oldValue = input.value;
            
            // ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^\d]/g, '');
            
            // ë¹ˆ ê°’ ì²˜ë¦¬
            if (value === '') {
                input.value = '0 ì›';
                input.setSelectionRange(0, 0);
                return;
            }
            
            let number = parseInt(value) || 0;
            
            // ìƒˆ ê°’ ì„¤ì •
            const formatted = number.toLocaleString() + ' ì›';
            input.value = formatted;
            
            // ì»¤ì„œ ìœ„ì¹˜ ê³„ì‚° (ì½¤ë§ˆ ê³ ë ¤)
            const oldNumbers = oldValue.replace(/[^\d]/g, '');
            const newNumbers = formatted.replace(/[^\d]/g, '');
            
            // ìˆ«ì ë¶€ë¶„ ê¸¸ì´
            const numberPart = formatted.indexOf(' ì›');
            
            // ì»¤ì„œë¥¼ ìˆ«ì ëìœ¼ë¡œ
            input.setSelectionRange(numberPart, numberPart);
        }
        
        // í´ë¦­ ì‹œ ì»¤ì„œë¥¼ ìˆ«ì ëìœ¼ë¡œ ì´ë™
        function moveStopLossCursor(input) {
            const value = input.value;
            const numberEnd = value.indexOf(' ì›');
            if (numberEnd > 0) {
                input.setSelectionRange(numberEnd, numberEnd);
            }
        }
        
        // í¬ì»¤ìŠ¤ ì‹œ ìˆ«ì ë¶€ë¶„ë§Œ ì„ íƒ
        function selectStopLossNumber(input) {
            const value = input.value;
            const numberEnd = value.indexOf(' ì›');
            if (numberEnd > 0) {
                input.setSelectionRange(0, numberEnd);
            }
        }
        
        // ê°€ê²©ìœ¼ë¡œ ë¹„ìœ¨ ê³„ì‚°
        function updateStopLossPercentFromPrice() {
            const input = document.getElementById('stopLossPriceInput');
            const stopLossPrice = parseInt(input.value.replace(/[^\d]/g, '')) || 0;
            const currentPrice = getCurrentBuyPrice();
            
            if (currentPrice > 0) {
                const percent = ((currentPrice - stopLossPrice) / currentPrice * 100).toFixed(2);
                document.getElementById('stopLossPercentDisplay').textContent = percent + '%';
                
                // ë¯¸êµ­ ì£¼ì‹ì€ ë‹¬ëŸ¬ë„ í‘œì‹œ
                const usdElement = document.getElementById('stopLossPriceUSD');
                if (!isKorean(currentStock)) {
                    const usd = (stopLossPrice / USD_TO_KRW).toFixed(2);
                    usdElement.textContent = '$' + usd;
                    usdElement.style.display = 'block';
                } else {
                    usdElement.style.display = 'none';
                }
            }
        }
        
        // ìŠ¤íƒ‘ë¡œìŠ¤ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
        function getStopLossPrice() {
            const type = document.querySelector('input[name="stopLossType"]:checked').value;
            
            if (type === 'percent') {
                const percent = parseFloat(document.getElementById('stopLossPercent').value) || 10;
                const currentPrice = getCurrentBuyPrice();
                return Math.round(currentPrice * (1 - percent / 100));
            } else {
                const input = document.getElementById('stopLossPriceInput');
                return parseInt(input.value.replace(/[^\d]/g, '')) || 0;
            }
        }
        
        // ìŠ¤íƒ‘ë¡œìŠ¤ ì²´í¬ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œ)
        function checkStopLoss() {
            if (!portfolio.stopLoss || portfolio.shares === 0) return;
            
            const currentPrice = stockData[stockData.length - 1].price;
            const currentPriceKRW = isKorean(currentStock) ? currentPrice : currentPrice * USD_TO_KRW;
            
            if (currentPriceKRW <= portfolio.stopLoss) {
                // ìŠ¤íƒ‘ë¡œìŠ¤ ë°œë™!
                executeStopLoss(currentPrice);
            }
        }
        
        // ìŠ¤íƒ‘ë¡œìŠ¤ ì‹¤í–‰
        function executeStopLoss(price) {
            const quantity = portfolio.shares;
            
            // ì „ëŸ‰ ë§¤ë„
            const totalCostUSD = isKorean(currentStock) ?
                (price * quantity) / USD_TO_KRW :
                price * quantity;
            
            portfolio.shares = 0;
            portfolio.cash += totalCostUSD;
            portfolio.stopLoss = null;
            portfolio.buyPrice = null;
            
            const currentStockValueUSD = 0;
            portfolio.value = portfolio.cash + currentStockValueUSD;
            
            addTrade('sell', quantity, price);
            updateUI();
            
            const displayPrice = isKorean(currentStock) ?
                Math.round(price).toLocaleString() + 'ì›' :
                '$' + price.toFixed(2);
            
            const loss = ((portfolio.value - 3000) / 3000 * 100).toFixed(2);
            
            showToast('ğŸ›‘ ìŠ¤íƒ‘ë¡œìŠ¤ ë°œë™!\n\n' + quantity + 'ì£¼ ' + displayPrice + ' ì „ëŸ‰ ë§¤ë„\nì†ì‹¤: ' + loss + '%');
        }

        async function loadStockData() {
            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'ğŸ“¥ ë¡œë”© ì¤‘...';
            
            document.getElementById('chartLoading').innerHTML = '<p>ğŸ”„ ì‹¤ì œ ì£¼ì‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            
            try {
                // ë°±ì—”ë“œ API í˜¸ì¶œ
                const response = await fetch(`${API_URL}/api/stock/${currentStock}`);
                
                if (!response.ok) {
                    throw new Error('ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // ë°±ì—”ë“œì—ì„œ ë°›ì€ ë°ì´í„° ì €ì¥ (1ë…„ ë°ì´í„°)
                const yearData = result.data.map(d => ({
                    date: d.date,
                    price: d.price,
                    open: d.open,
                    high: d.high,
                    low: d.low,
                    volume: d.volume
                }));
                
                // 1ë…„ ë°ì´í„° ì €ì¥
                allStockData['1Y'] = yearData;
                
                // ì‹¤ì‹œê°„(1D) ë°ì´í„° ë¡œë“œ (ê¸°ë³¸ í‘œì‹œ)
                await loadPeriodData('1D');
                
                // ì‹¤ì‹œê°„ íƒ­ í™œì„±í™”
                currentPeriod = '1D';
                document.querySelectorAll('.period-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.period === '1D') {
                        tab.classList.add('active');
                    }
                });
                
                // ì£¼ì‹ ì •ë³´ í‘œì‹œ
                document.getElementById('stockInfo').style.display = 'block';
                document.getElementById('stockName').textContent = result.name;
                document.getElementById('stockSector').textContent = result.sector;
                document.getElementById('stockExchange').textContent = result.exchange;
                
                // ê¸°ê°„ ì„ íƒ íƒ­ í‘œì‹œ
                document.getElementById('periodTabs').style.display = 'flex';
                
                // ì°¨íŠ¸ ê°€ê²© í‘œì‹œ ì˜ì—­ í‘œì‹œ
                document.getElementById('chartPriceDisplay').style.display = 'block';
                
                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                document.getElementById('chart').style.display = 'block';
                document.getElementById('chartLoading').style.display = 'none';
                drawChart();
                updateUI();
                updateChartInfo();
                
                // ì´ˆê¸° ì‹¤ì‹œê°„ ê°€ê²© ì €ì¥ ë° í‘œì‹œ
                realtimePrice = stockData[stockData.length - 1].price;
                if (isKorean(currentStock)) {
                    document.getElementById('currentPrice').textContent = Math.round(realtimePrice).toLocaleString() + 'ì›';
                } else {
                    document.getElementById('currentPrice').textContent = '$' + realtimePrice.toFixed(2);
                }
                document.getElementById('stockSymbol').textContent = currentStock;
                
                // AI í•™ìŠµ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('trainBtn').disabled = false;
                document.getElementById('buyBtn').disabled = false;
                document.getElementById('sellBtn').disabled = false;
                
                hideError();
                
                // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘ (2ì´ˆë§ˆë‹¤)
                if (priceUpdateInterval) {
                    clearInterval(priceUpdateInterval);
                }
                priceUpdateInterval = setInterval(() => {
                    updateRealtimePrice();
                }, 2000); // 2ì´ˆ
                
            } catch (error) {
                console.error('Data loading error:', error);
                showError('âŒ ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì„œë²„ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”:\npython3 backend_server.py');
                document.getElementById('chartLoading').innerHTML = '<p>âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p><p style="font-size: 0.9em; color: #f59e0b; margin-top: 10px;">ë°±ì—”ë“œ ì„œë²„(í¬íŠ¸ 5000)ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”</p>';
            }
            
            loadBtn.disabled = false;
            loadBtn.textContent = 'ğŸ“¥ ë°ì´í„° ë¡œë“œ';
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ë¡œë“œ (í´ë°±)
        function loadSimulationData() {
            const today = new Date();
            const basePrice = isKorean(currentStock) ? 62000 : 283;
            
            stockData = [];
            let price = basePrice;
            
            for (let i = 99; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                const change = (Math.random() - 0.5) * 6;
                price = price * (1 + change / 100);
                
                const dayHigh = price * (1 + Math.random() * 0.02);
                const dayLow = price * (1 - Math.random() * 0.02);
                
                stockData.push({
                    date: date.toISOString(),
                    price: price,
                    open: price * (1 + (Math.random() - 0.5) * 0.01),
                    high: dayHigh,
                    low: dayLow,
                    volume: Math.floor(Math.random() * 10000000)
                });
            }
            
            const stockNames = {
                'AAPL': 'Apple Inc.',
                'GOOGL': 'Alphabet Inc.',
                'MSFT': 'Microsoft Corporation',
                'TSLA': 'Tesla Inc.',
                'AMZN': 'Amazon.com Inc.',
                'META': 'Meta Platforms Inc.',
                'NVDA': 'NVIDIA Corporation',
                '005930.KS': 'ì‚¼ì„±ì „ì',
                '000660.KS': 'SKí•˜ì´ë‹‰ìŠ¤',
                '035420.KS': 'NAVER',
                '035720.KS': 'ì¹´ì¹´ì˜¤',
                '051910.KS': 'LGí™”í•™',
                '006400.KS': 'ì‚¼ì„±SDI',
                '207940.KS': 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤',
                '005380.KS': 'í˜„ëŒ€ì°¨'
            };
            
            const stockSectors = {
                'AAPL': 'Technology',
                'GOOGL': 'Technology',
                'MSFT': 'Technology',
                'TSLA': 'Automotive',
                'AMZN': 'Consumer Cyclical',
                'META': 'Technology',
                'NVDA': 'Technology',
                '005930.KS': 'ì „ì',
                '000660.KS': 'ë°˜ë„ì²´',
                '035420.KS': 'ì¸í„°ë„·',
                '035720.KS': 'ì¸í„°ë„·',
                '051910.KS': 'í™”í•™',
                '006400.KS': 'ì „ê¸°ì „ì',
                '207940.KS': 'ì œì•½',
                '005380.KS': 'ìë™ì°¨'
            };
            
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('stockName').textContent = stockNames[currentStock] || currentStock;
            document.getElementById('stockSector').textContent = stockSectors[currentStock] || 'General';
            document.getElementById('stockExchange').textContent = isKorean(currentStock) ? 'KOSPI' : 'NASDAQ';
            
            document.getElementById('chart').style.display = 'block';
            document.getElementById('chartLoading').style.display = 'none';
            drawChart();
            updateUI();
            
            document.getElementById('trainBtn').disabled = false;
            document.getElementById('buyBtn').disabled = false;
            document.getElementById('sellBtn').disabled = false;
            
            hideError();
            
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
            priceUpdateInterval = setInterval(() => {
                updateRealtimePrice();
            }, 5000);
        }

        // ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ (ë°±ì—”ë“œ API)
        async function updateRealtimePrice() {
            try {
                if (stockData.length === 0) return;
                
                const oldPrice = realtimePrice; // realtimePrice ì‚¬ìš©
                
                console.log(`ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìš”ì²­: ${currentStock} (ì´ì „ ê°€ê²©: ${oldPrice})`);
                
                const response = await fetch(`${API_URL}/api/stock/${currentStock}/latest`);
                
                if (!response.ok) {
                    console.log('âŒ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', response.status);
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    console.log('âŒ API ì—ëŸ¬:', data.error);
                    return;
                }
                
                let newPrice = data.price;
                
                // ğŸ­ ë¯¸ì¥ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ: ì‹¤ì œ ê°œì¥ì²˜ëŸ¼ ê°€ê²© ë³€ë™
                if (!isKorean(currentStock)) {
                    // ì‹¤ì œ ê°€ê²©ì˜ Â±0.5% ë²”ìœ„ì—ì„œ ëœë¤ ë³€ë™
                    const volatility = 0.005; // 0.5%
                    const randomChange = (Math.random() - 0.5) * 2 * volatility; // -0.5% ~ +0.5%
                    newPrice = data.price * (1 + randomChange);
                    
                    // ì†Œìˆ˜ì  2ìë¦¬ë¡œ ë°˜ì˜¬ë¦¼
                    newPrice = Math.round(newPrice * 100) / 100;
                    
                    console.log(`ğŸ­ ì‹œë®¬ë ˆì´ì…˜ ê°€ê²©: ${data.price} â†’ ${newPrice} (${(randomChange * 100).toFixed(2)}%)`);
                }
                
                console.log(`ğŸ“Š ìƒˆ ê°€ê²© ìˆ˜ì‹ : ${newPrice} (ë³€ë™: ${(newPrice - oldPrice).toFixed(2)})`);
                
                realtimePrice = newPrice; // realtimePrice ì—…ë°ì´íŠ¸
                
                const now = new Date();
                const newDataPoint = {
                    date: now.toISOString(),
                    price: newPrice,
                    open: data.open,
                    high: data.high,
                    low: data.low,
                    volume: data.volume
                };
                
                // ì‹¤ì‹œê°„ íƒ­ì´ë©´ ìƒˆ ì  ì¶”ê°€
                if (currentPeriod === '1D') {
                    // ì‹¤ì‹œê°„ ë°ì´í„°ì—ë§Œ ì¶”ê°€
                    stockData.push(newDataPoint);
                    
                    // ì›ë³¸ ìºì‹œì—ë„ ì¶”ê°€
                    if (!allStockData['1D']) {
                        allStockData['1D'] = [];
                    }
                    allStockData['1D'].push(newDataPoint);
                    
                    // ìµœê·¼ 200ê°œë§Œ ìœ ì§€
                    if (stockData.length > 200) {
                        stockData.shift();
                        allStockData['1D'].shift();
                    }
                }
                // ë‹¤ë¥¸ íƒ­: ì°¨íŠ¸ëŠ” ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ê³ ì • ë°ì´í„°)
                // ì‹¤ì‹œê°„ ê°€ê²©ë§Œ ë³„ë„ë¡œ í‘œì‹œë˜ë¯€ë¡œ ì°¨íŠ¸ ë°ì´í„°ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
                
                // ê°€ê²© ë³€ë™ ì• ë‹ˆë©”ì´ì…˜ (realtimePrice ê¸°ì¤€)
                if (oldPrice !== newPrice) {
                    const priceElement = document.getElementById('currentPrice');
                    
                    // ê¹œë¹¡ì„ íš¨ê³¼
                    priceElement.classList.remove('price-up', 'price-down');
                    void priceElement.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ
                    
                    if (newPrice > oldPrice) {
                        priceElement.classList.add('price-up');
                    } else if (newPrice < oldPrice) {
                        priceElement.classList.add('price-down');
                    }
                    
                    // ìˆ«ì ì¹´ìš´íŠ¸ì—… ì• ë‹ˆë©”ì´ì…˜
                    animatePriceUpdate(priceElement, oldPrice, newPrice);
                }
                
                // ì‹¬ë³¼ ì—…ë°ì´íŠ¸ (í•­ìƒ)
                document.getElementById('stockSymbol').textContent = currentStock;
                
                // ìŠ¤íƒ‘ë¡œìŠ¤ ì²´í¬
                checkStopLoss();
                
                // ì°¨íŠ¸ ë° UI ì—…ë°ì´íŠ¸
                drawChart();
                updateUI();
                updateChartInfo(); // ì°¨íŠ¸ í•˜ë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸
                
                // ê±°ë˜ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ê°€ê²©ë„ ì—…ë°ì´íŠ¸ (í˜„ì¬ê°€ íƒ­ë§Œ)
                if (document.getElementById('tradeModal').classList.contains('show')) {
                    // í˜„ì¬ê°€ íƒ­ì¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
                    if (currentPriceType === 'current') {
                        updatePriceDisplay(newPrice);
                    }
                }
            } catch (error) {
                console.log('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê°€ê²© ìˆ«ì ì• ë‹ˆë©”ì´ì…˜
        function animatePriceUpdate(element, startPrice, endPrice) {
            const duration = 500;
            const startTime = performance.now();
            const priceDiff = endPrice - startPrice;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // easeOutCubic íš¨ê³¼
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentPrice = startPrice + (priceDiff * easeProgress);
                
                if (isKorean(currentStock)) {
                    element.textContent = Math.round(currentPrice).toLocaleString() + 'ì›';
                } else {
                    element.textContent = '$' + currentPrice.toFixed(2);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    if (isKorean(currentStock)) {
                        element.textContent = Math.round(endPrice).toLocaleString() + 'ì›';
                    } else {
                        element.textContent = '$' + endPrice.toFixed(2);
                    }
                }
            }
            
            requestAnimationFrame(update);
        }

        function isKorean(symbol) {
            return symbol.includes('.KS');
        }

        function drawChart() {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');
            
            // ë°ì´í„° ê²€ì¦
            if (!stockData || stockData.length === 0) {
                console.log('ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            console.log(`ì°¨íŠ¸ ê·¸ë¦¬ê¸°: ${stockData.length}ê°œ ë°ì´í„°`);
            
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = 350 * dpr;
            ctx.scale(dpr, dpr);

            const width = canvas.offsetWidth;
            const height = 350;
            ctx.clearRect(0, 0, width, height);
            
            const padding = 50;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            const prices = stockData.map(d => d.price);
            const max = Math.max(...prices);
            const min = Math.min(...prices);
            const range = max - min;

            // Yì¶• ê·¸ë¦¬ë“œ ë° ë ˆì´ë¸”
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                const price = max - (range / 5) * i;
                
                // ê·¸ë¦¬ë“œ ë¼ì¸
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Yì¶• ë ˆì´ë¸” (ê°€ê²©) - ì‹¤ì‹œê°„ íƒ­ ì œì™¸
                if (currentPeriod !== '1D') {
                    ctx.fillStyle = '#888';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'right';
                    
                    let priceLabel;
                    if (isKorean(currentStock)) {
                        // í•œêµ­ ì£¼ì‹: ë§Œ/ì²œ ë‹¨ìœ„ë¡œ í‘œì‹œ
                        if (price >= 10000) {
                            priceLabel = (price / 10000).toFixed(1) + 'ë§Œ';
                        } else if (price >= 1000) {
                            priceLabel = (price / 1000).toFixed(1) + 'ì²œ';
                        } else {
                            priceLabel = Math.round(price).toLocaleString();
                        }
                    } else {
                        // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ í‘œì‹œ
                        priceLabel = '$' + price.toFixed(0);
                    }
                    
                    ctx.fillText(priceLabel, padding - 10, y + 4);
                }
            }
            
            // Xì¶• ë ˆì´ë¸” (ë‚ ì§œ) - ì‹¤ì‹œê°„ íƒ­ ì œì™¸
            if (currentPeriod !== '1D') {
                ctx.textAlign = 'center';
                ctx.fillStyle = '#888';
                
                const labelCount = 5;
                for (let i = 0; i <= labelCount; i++) {
                    const dataIndex = Math.floor((stockData.length - 1) * i / labelCount);
                    const x = padding + (dataIndex / (stockData.length - 1)) * chartWidth;
                    const date = new Date(stockData[dataIndex].date);
                    
                    let dateLabel = '';
                    if (currentPeriod === '1W') {
                        // 1ì£¼: ì›”/ì¼
                        dateLabel = (date.getMonth() + 1) + '/' + date.getDate();
                    } else if (currentPeriod === '3Y') {
                        // 3ë…„: ë…„/ì›”
                        dateLabel = date.getFullYear().toString().slice(2) + '/' + (date.getMonth() + 1);
                    } else {
                        // 3ë‹¬, 1ë…„: ë…„/ì›”  
                        dateLabel = date.getFullYear().toString().slice(2) + '/' + (date.getMonth() + 1);
                    }
                    
                    ctx.fillText(dateLabel, x, height - padding + 20);
                }
            }

            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.beginPath();

            // ë¶€ë“œëŸ¬ìš´ ê³¡ì„  ê·¸ë˜í”„ (Catmull-Rom Spline)
            const points = stockData.map((item, i) => {
                const x = padding + (i / (stockData.length - 1)) * chartWidth;
                const y = padding + chartHeight - ((item.price - min) / range) * chartHeight;
                return { x, y };
            });

            if (points.length > 0) {
                ctx.moveTo(points[0].x, points[0].y);

                if (points.length === 1) {
                    // ì ì´ 1ê°œë©´ ê·¸ëƒ¥ ì 
                    ctx.lineTo(points[0].x, points[0].y);
                } else if (points.length === 2) {
                    // ì ì´ 2ê°œë©´ ì§ì„ 
                    ctx.lineTo(points[1].x, points[1].y);
                } else {
                    // 3ê°œ ì´ìƒì´ë©´ ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                    for (let i = 0; i < points.length - 1; i++) {
                        const p0 = points[Math.max(0, i - 1)];
                        const p1 = points[i];
                        const p2 = points[i + 1];
                        const p3 = points[Math.min(points.length - 1, i + 2)];

                        // Catmull-Romì„ Bezierë¡œ ë³€í™˜
                        const cp1x = p1.x + (p2.x - p0.x) / 6;
                        const cp1y = p1.y + (p2.y - p0.y) / 6;
                        const cp2x = p2.x - (p3.x - p1.x) / 6;
                        const cp2y = p2.y - (p3.y - p1.y) / 6;

                        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
                    }
                }
            }
            ctx.stroke();

            // ê·¸ë¼ë°ì´ì…˜ ì˜ì—­
            const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            ctx.fillStyle = gradient;
            
            if (points.length > 0) {
                ctx.lineTo(points[points.length - 1].x, height - padding);
                ctx.lineTo(points[0].x, height - padding);
                ctx.closePath();
                ctx.fill();
            }

        }

        function drawPredictionChart() {
            const canvas = document.getElementById('predChart');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = 350 * dpr;
            ctx.scale(dpr, dpr);

            const width = canvas.offsetWidth;
            const height = 350;
            ctx.clearRect(0, 0, width, height);
            
            const padding = 50;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            const max = Math.max(...predictionData);
            const min = Math.min(...predictionData);
            const range = max - min;

            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            
            // Yì¶• ê·¸ë¦¬ë“œ + ë ˆì´ë¸”
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                
                // ê·¸ë¦¬ë“œ ë¼ì¸
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Yì¶• ë ˆì´ë¸” (ê°€ê²©)
                const price = max - (range / 5) * i;
                ctx.fillStyle = '#888';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                
                let priceLabel;
                if (isKorean(currentStock)) {
                    // í•œêµ­ ì£¼ì‹: ë§Œ/ì²œ ë‹¨ìœ„ë¡œ í‘œì‹œ
                    if (price >= 10000) {
                        priceLabel = (price / 10000).toFixed(1) + 'ë§Œ';
                    } else if (price >= 1000) {
                        priceLabel = (price / 1000).toFixed(1) + 'ì²œ';
                    } else {
                        priceLabel = Math.round(price).toLocaleString();
                    }
                } else {
                    // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ í‘œì‹œ
                    priceLabel = '$' + price.toFixed(0);
                }
                
                ctx.fillText(priceLabel, padding - 10, y + 4);
            }

            ctx.strokeStyle = '#a78bfa';
            ctx.lineWidth = 3;
            ctx.beginPath();

            // ë¶€ë“œëŸ¬ìš´ ê³¡ì„  ê·¸ë˜í”„ (Catmull-Rom Spline)
            const points = predictionData.map((price, i) => {
                const x = padding + (i / (predictionData.length - 1)) * chartWidth;
                const y = padding + chartHeight - ((price - min) / range) * chartHeight;
                return { x, y };
            });

            if (points.length > 0) {
                ctx.moveTo(points[0].x, points[0].y);

                if (points.length === 1) {
                    ctx.lineTo(points[0].x, points[0].y);
                } else if (points.length === 2) {
                    ctx.lineTo(points[1].x, points[1].y);
                } else {
                    // 3ê°œ ì´ìƒì´ë©´ ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                    for (let i = 0; i < points.length - 1; i++) {
                        const p0 = points[Math.max(0, i - 1)];
                        const p1 = points[i];
                        const p2 = points[i + 1];
                        const p3 = points[Math.min(points.length - 1, i + 2)];

                        // Catmull-Romì„ Bezierë¡œ ë³€í™˜
                        const cp1x = p1.x + (p2.x - p0.x) / 6;
                        const cp1y = p1.y + (p2.y - p0.y) / 6;
                        const cp2x = p2.x - (p3.x - p1.x) / 6;
                        const cp2y = p2.y - (p3.y - p1.y) / 6;

                        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
                    }
                }
            }
            ctx.stroke();

            // Xì¶• ë ˆì´ë¸” (ë‚ ì§œ) ì¶”ê°€
            ctx.textAlign = 'center';
            ctx.fillStyle = '#888';
            ctx.font = '12px Arial';
            
            const today = new Date();
            const labelCount = 5;
            
            for (let i = 0; i <= labelCount; i++) {
                const dayIndex = Math.floor((predictionData.length - 1) * i / labelCount);
                const x = padding + (dayIndex / (predictionData.length - 1)) * chartWidth;
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë¯¸ë˜ ë‚ ì§œ ê³„ì‚°
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + dayIndex);
                
                const month = futureDate.getMonth() + 1;
                const day = futureDate.getDate();
                const dateLabel = month + '/' + day;
                
                ctx.fillText(dateLabel, x, height - padding + 20);
            }

            // ê·¸ë¼ë””ì–¸íŠ¸ ì˜ì—­
            const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
            gradient.addColorStop(0, 'rgba(167, 139, 250, 0.4)');
            gradient.addColorStop(1, 'rgba(167, 139, 250, 0)');
            ctx.fillStyle = gradient;
            
            ctx.lineTo(width - padding, height - padding);
            ctx.lineTo(padding, height - padding);
            ctx.closePath();
            ctx.fill();
        }

        async function trainAI() {
            const btn = document.getElementById('trainBtn');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            
            btn.disabled = true;
            progressBar.style.display = 'block';
            
            try {
                console.log('=== AI í•™ìŠµ ì‹œì‘ ===');
                
                // 1ë…„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë“œ
                if (!allStockData['1Y']) {
                    showToast('ğŸ“Š í•™ìŠµìš© ë°ì´í„° ë¡œë”© ì¤‘...');
                    const response = await fetch(`${API_URL}/api/stock/${currentStock}?period=1y`);
                    if (!response.ok) {
                        throw new Error('1ë…„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const result = await response.json();
                    allStockData['1Y'] = result.data;
                }
                
                // ìµœê·¼ 100ì¼ë§Œ ì‚¬ìš©
                const yearData = allStockData['1Y'];
                const trainingData = yearData.slice(-100);
                
                console.log(`1ë…„ ì „ì²´ ë°ì´í„°: ${yearData.length}ê°œ`);
                console.log(`í•™ìŠµ ë°ì´í„°: ìµœê·¼ ${trainingData.length}ì¼`);
                console.log(`í•™ìŠµ ê¸°ê°„: ${trainingData[0].date} ~ ${trainingData[trainingData.length-1].date}`);
                
                // ë°ì´í„° ê²€ì¦
                const seqLength = 60;
                if (trainingData.length < seqLength + 30) {
                    throw new Error(`AI í•™ìŠµì—ëŠ” ìµœì†Œ ${seqLength + 30}ê°œì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.\ní˜„ì¬: ${trainingData.length}ê°œ`);
                }
                
                const prices = trainingData.map(d => d.price);
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                const range = max - min;
                
                if (range === 0) {
                    throw new Error('ê°€ê²© ë³€ë™ì´ ì—†ì–´ í•™ìŠµí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                normalizeParams = { min, max, range };
                
                const normalized = prices.map(p => (p - min) / range);
                
                const X = [];
                const y = [];
                
                for (let i = 0; i < normalized.length - seqLength; i++) {
                    X.push(normalized.slice(i, i + seqLength).map(v => [v]));
                    y.push([normalized[i + seqLength]]);
                }
                
                if (X.length === 0) {
                    throw new Error('í•™ìŠµ ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const xTensor = tf.tensor3d(X);
                const yTensor = tf.tensor2d(y);
                
                if (!lstmModel) {
                    lstmModel = tf.sequential();
                    lstmModel.add(tf.layers.lstm({ units: 50, returnSequences: true, inputShape: [60, 1] }));
                    lstmModel.add(tf.layers.dropout({ rate: 0.2 }));
                    lstmModel.add(tf.layers.lstm({ units: 50 }));
                    lstmModel.add(tf.layers.dropout({ rate: 0.2 }));
                    lstmModel.add(tf.layers.dense({ units: 1 }));
                    lstmModel.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
                }
                
                await lstmModel.fit(xTensor, yTensor, {
                    epochs: 50,
                    batchSize: 16,
                    callbacks: {
                        onEpochEnd: (epoch) => {
                            const percent = ((epoch + 1) / 50) * 100;
                            progress.style.width = percent + '%';
                            progress.textContent = percent.toFixed(0) + '% í•™ìŠµ ì¤‘...';
                        }
                    }
                });
                
                predictionData = [];
                let currentSeq = normalized.slice(-60);
                
                // ê³¼ê±° ë³€ë™ì„± ê³„ì‚° (ìµœê·¼ 30ì¼)
                const recentPrices = prices.slice(-30);
                const priceChanges = [];
                for (let i = 1; i < recentPrices.length; i++) {
                    const change = Math.abs(recentPrices[i] - recentPrices[i-1]) / recentPrices[i-1];
                    priceChanges.push(change);
                }
                const avgVolatility = priceChanges.reduce((a, b) => a + b, 0) / priceChanges.length;
                
                console.log(`í‰ê·  ë³€ë™ì„±: ${(avgVolatility * 100).toFixed(2)}%`);
                
                // íŠ¸ë Œë“œ ê³„ì‚° (ì „ì²´ ë°ì´í„°)
                const firstPrice = prices[0];
                const lastPrice = prices[prices.length - 1];
                const overallTrend = (lastPrice - firstPrice) / firstPrice / prices.length;
                
                console.log(`ì „ì²´ íŠ¸ë Œë“œ: ${(overallTrend * 100).toFixed(4)}% per day`);
                
                for (let i = 0; i < 30; i++) {
                    const input = tf.tensor3d([currentSeq.map(v => [v])]);
                    const pred = lstmModel.predict(input);
                    let predValue = (await pred.data())[0];
                    
                    // 1. ëœë¤ ë…¸ì´ì¦ˆ (ë³€ë™ì„± ê¸°ë°˜, ì¤„ì„)
                    const noise = (Math.random() - 0.5) * avgVolatility * 0.8;  // 1.5 â†’ 0.8
                    
                    // 2. ì‹œê°„ì— ë”°ë¥¸ ë¶ˆí™•ì‹¤ì„± ì¦ê°€ (ì™„ë§Œí•˜ê²Œ)
                    const uncertaintyFactor = 1 + (i / 30) * 0.2;  // 0.5 â†’ 0.2
                    
                    // 3. ê°•í™”ëœ í‰ê·  íšŒê·€ (ê·¹ë‹¨ ë°©ì§€)
                    const meanReversion = (0.5 - predValue) * 0.15;  // 0.05 â†’ 0.15
                    
                    // 4. íŠ¸ë Œë“œ ë°˜ì˜ (í˜„ì‹¤ì ì¸ ì¶”ì„¸)
                    const trendEffect = overallTrend * (i + 1) * 0.3;  // ì¶”ê°€
                    
                    // ëª¨ë“  ìš”ì†Œ ê²°í•©
                    predValue = predValue + (noise * uncertaintyFactor) + meanReversion + trendEffect;
                    
                    // 0~1 ë²”ìœ„ ìœ ì§€ (ë” ì¢ì€ ë²”ìœ„)
                    predValue = Math.max(0.2, Math.min(0.8, predValue));  // 0.1-0.9 â†’ 0.2-0.8
                    
                    const actualPrice = predValue * range + min;
                    
                    predictionData.push(actualPrice);
                    currentSeq = [...currentSeq.slice(1), predValue];
                    
                    input.dispose();
                    pred.dispose();
                }
                
                console.log(`ì˜ˆì¸¡ ìƒì„± ì™„ë£Œ: ${predictionData.length}ì¼`);
                console.log(`ì˜ˆì¸¡ ë²”ìœ„: $${Math.min(...predictionData).toFixed(2)} ~ $${Math.max(...predictionData).toFixed(2)}`);
                
                document.getElementById('predictionChart').style.display = 'block';
                drawPredictionChart();
                
                generateRecommendation();
                
                xTensor.dispose();
                yTensor.dispose();
                
                showToast('AI í•™ìŠµ ì™„ë£Œ!');
                
            } catch (error) {
                console.error('Training error:', error);
                showToast('âŒ ' + error.message);
            }
            
            btn.disabled = false;
            progressBar.style.display = 'none';
        }

        function generateRecommendation() {
            const currentPrice = stockData[stockData.length - 1].price;
            const futurePrice = predictionData[predictionData.length - 1];
            const change = ((futurePrice - currentPrice) / currentPrice * 100).toFixed(2);
            
            let action = 'hold';
            let strength = 'MODERATE';
            if (change > 5) {
                action = 'buy';
                strength = change > 10 ? 'STRONG' : 'MODERATE';
            } else if (change < -5) {
                action = 'sell';
                strength = change < -10 ? 'STRONG' : 'MODERATE';
            }
            
            aiRecommendation = {
                action: action,
                change: change,
                current: currentPrice,
                target: futurePrice,
                stopLoss: currentPrice * (action === 'buy' ? 0.95 : 1.05),
                confidence: (75 + Math.random() * 20).toFixed(0),
                position: Math.abs(parseFloat(change)) > 10 ? 30 : 20,
                strength: strength
            };
            
            console.log('=== AI ì¶”ì²œ ìƒì„± ===');
            console.log('currentStock:', currentStock);
            console.log('portfolio.cash:', portfolio.cash);
            console.log('aiRecommendation.position:', aiRecommendation.position);
            console.log('íˆ¬ì ê¸ˆì•¡ (ë‹¬ëŸ¬):', portfolio.cash * aiRecommendation.position / 100);
            
            // ê°€ê²© í¬ë§· ë¯¸ë¦¬ ì²˜ë¦¬
            const formattedCurrent = formatPrice(aiRecommendation.current);
            const formattedTarget = formatPrice(aiRecommendation.target);
            const formattedStopLoss = formatPrice(aiRecommendation.stopLoss);
            const formattedInvestAmount = formatCashAmount(portfolio.cash * aiRecommendation.position / 100);
            
            console.log('formattedInvestAmount:', formattedInvestAmount);

            const recDiv = document.getElementById('aiRecommendation');
            recDiv.className = 'ai-recommendation show ' + action;
            recDiv.innerHTML = `
                <div class="recommendation-header">
                    <h2>âš¡ AI íˆ¬ì ì¶”ì²œ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)</h2>
                    <span class="badge-action ${action}">
                        ${action === 'buy' ? 'ğŸŸ¢ ë§¤ìˆ˜ ì¶”ì²œ' : action === 'sell' ? 'ğŸ”´ ë§¤ë„ ì¶”ì²œ' : 'âšª ê´€ë§'}
                    </span>
                </div>
                <div class="rec-details">
                    <div class="rec-box">
                        <h4>ğŸ“Š ë¶„ì„ ê²°ê³¼</h4>
                        <div class="rec-item">
                            <label>ì¶”ì²œ ê°•ë„</label>
                            <div class="value" style="color: ${strength === 'STRONG' ? '#10b981' : '#fbbf24'}">${strength}</div>
                        </div>
                        <div class="rec-item">
                            <label>ì‹ ë¢°ë„</label>
                            <div class="value" style="color: #60a5fa">${aiRecommendation.confidence}%</div>
                        </div>
                        <div class="rec-item">
                            <label>ì˜ˆìƒ ë³€ë™</label>
                            <div class="value" style="color: ${change > 0 ? '#10b981' : '#ef4444'}">
                                ${change > 0 ? '+' : ''}${change}%
                            </div>
                        </div>
                    </div>

                    <div class="rec-box">
                        <h4>ğŸ¯ ê°€ê²© ëª©í‘œ</h4>
                        <div class="rec-item">
                            <label>í˜„ì¬ê°€</label>
                            <div class="value">${formattedCurrent}</div>
                        </div>
                        <div class="rec-item">
                            <label>ëª©í‘œê°€</label>
                            <div class="value" style="color: #10b981">${formattedTarget}</div>
                        </div>
                        <div class="rec-item">
                            <label>ì†ì ˆê°€</label>
                            <div class="value" style="color: #ef4444">${formattedStopLoss}</div>
                        </div>
                    </div>

                    <div class="rec-box">
                        <h4>ğŸ›¡ï¸ íˆ¬ì ì „ëµ</h4>
                        <div class="rec-item">
                            <label>ê¶Œì¥ ë¹„ì¤‘</label>
                            <div class="value" style="color: #a78bfa">${aiRecommendation.position}%</div>
                        </div>
                        <div class="rec-item">
                            <label>íˆ¬ì ê¸ˆì•¡</label>
                            <div class="value" style="color: #fbbf24">
                                ${formattedInvestAmount}
                            </div>
                        </div>
                        <button class="ai-execute" onclick="executeAIRecommendation()">
                            ğŸš€ AI ì¶”ì²œ ì‹¤í–‰
                        </button>
                    </div>
                </div>
            `;
        }

        function executeAIRecommendation() {
            if (!aiRecommendation) {
                showToast('AI í•™ìŠµì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (aiRecommendation.action === 'hold') {
                showToast('í˜„ì¬ AIëŠ” "ê´€ë§"ì„ ì¶”ì²œí•˜ê³  ìˆìŠµë‹ˆë‹¤.\n\nì˜ˆìƒ ë³€ë™: ' + aiRecommendation.change + '%\në³€ë™í­ì´ í¬ì§€ ì•Šì•„ ê±°ë˜ë¥¼ ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            openTradeModal(aiRecommendation.action);
            
            const price = stockData[stockData.length - 1].price;
            if (aiRecommendation.action === 'buy') {
                const maxShares = Math.floor(portfolio.cash / price);
                const recommendedShares = Math.floor(maxShares * aiRecommendation.position / 100);
                document.getElementById('quantityInput').value = recommendedShares;
            } else {
                const recommendedShares = Math.floor(portfolio.shares * aiRecommendation.position / 100);
                document.getElementById('quantityInput').value = recommendedShares;
            }
            updateTotalAmount();
        }

        let quoteUpdateInterval = null;

        // í˜¸ê°€ì°½ ì—´ê¸°
        function openQuoteModal() {
            if (stockData.length === 0) {
                showToast('ë¨¼ì € ì£¼ì‹ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            generateQuotes();
            document.getElementById('quoteModal').classList.add('show');
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘ (1ì´ˆë§ˆë‹¤)
            quoteUpdateInterval = setInterval(() => {
                generateQuotes();
            }, 1000);
        }

        // í˜¸ê°€ì°½ ë‹«ê¸°
        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('show');
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
            if (quoteUpdateInterval) {
                clearInterval(quoteUpdateInterval);
                quoteUpdateInterval = null;
            }
        }

        // í˜¸ê°€ ìƒì„± (ì‹¤ì‹œê°„ ìŠ¤íƒ€ì¼)
        function generateQuotes() {
            const currentPrice = stockData[stockData.length - 1].price;
            const priceKRW = isKorean(currentStock) ? Math.round(currentPrice) : Math.round(currentPrice * USD_TO_KRW);
            const priceUSD = isKorean(currentStock) ? (currentPrice / USD_TO_KRW).toFixed(2) : currentPrice.toFixed(2);
            
            // í˜¸ê°€ ê°„ê²© ì„¤ì •
            const tickSize = isKorean(currentStock) ? 10 : Math.round(USD_TO_KRW * 0.01); // ë¯¸êµ­ì€ $0.01 ë‹¨ìœ„
            
            // 52ì£¼ ìµœê³ /ìµœì €, ê±°ë˜ëŸ‰
            const prices = stockData.map(d => d.price);
            const high52 = Math.max(...prices);
            const low52 = Math.min(...prices);
            const totalVolume = stockData[stockData.length - 1].volume || 0;
            
            if (isKorean(currentStock)) {
                document.getElementById('week52High').textContent = Math.round(high52).toLocaleString() + 'ì›';
                document.getElementById('week52Low').textContent = Math.round(low52).toLocaleString() + 'ì›';
            } else {
                document.getElementById('week52High').textContent = '$' + high52.toFixed(2);
                document.getElementById('week52Low').textContent = '$' + low52.toFixed(2);
            }
            document.getElementById('volume').textContent = totalVolume.toLocaleString();
            
            // í˜„ì¬ê°€ í‘œì‹œ
            const currentQuoteDiv = document.getElementById('currentQuote');
            const currentPriceDiv = currentQuoteDiv.querySelector('.quote-price');
            const currentUSDDiv = currentQuoteDiv.querySelector('div[style*="font-size:0.85em"]');
            
            currentPriceDiv.textContent = priceKRW.toLocaleString() + 'ì›';
            if (!isKorean(currentStock)) {
                currentUSDDiv.textContent = '$' + priceUSD;
                currentUSDDiv.style.display = 'block';
            } else {
                currentUSDDiv.style.display = 'none';
            }
            
            // ë§¤ë„ í˜¸ê°€ ìƒì„± (ë†’ì€ ê°€ê²©ë¶€í„°) - ì‹¤ì‹œê°„ ë³€ë™
            let sellHTML = '';
            for (let i = 10; i >= 1; i--) {
                const sellPriceKRW = priceKRW + (tickSize * i);
                const sellPriceUSD = (sellPriceKRW / USD_TO_KRW).toFixed(2);
                // ëœë¤ ë³€ë™ìœ¼ë¡œ ì‹¤ì‹œê°„ì²˜ëŸ¼ ë³´ì´ê²Œ
                const volume = Math.floor(Math.random() * 500) + Math.floor(Math.random() * 100);
                const changePercent = ((sellPriceKRW - priceKRW) / priceKRW * 100).toFixed(2);
                
                sellHTML += `
                    <div class="quote-row quote-sell" onclick="selectQuote(${sellPriceKRW})">
                        <div class="quote-row-left">
                            <div class="quote-volume">${volume}</div>
                        </div>
                        <div class="quote-row-right">
                            <div class="quote-price">${sellPriceKRW.toLocaleString()}</div>
                            ${!isKorean(currentStock) ? `<div class="quote-usd">$${sellPriceUSD}</div>` : ''}
                            <div class="quote-change">+${changePercent}%</div>
                        </div>
                    </div>
                `;
            }
            
            // ë§¤ìˆ˜ í˜¸ê°€ ìƒì„± (ë†’ì€ ê°€ê²©ë¶€í„°) - ì‹¤ì‹œê°„ ë³€ë™
            let buyHTML = '';
            for (let i = 1; i <= 10; i++) {
                const buyPriceKRW = priceKRW - (tickSize * i);
                const buyPriceUSD = (buyPriceKRW / USD_TO_KRW).toFixed(2);
                // ëœë¤ ë³€ë™ìœ¼ë¡œ ì‹¤ì‹œê°„ì²˜ëŸ¼ ë³´ì´ê²Œ
                const volume = Math.floor(Math.random() * 500) + Math.floor(Math.random() * 100);
                const changePercent = ((buyPriceKRW - priceKRW) / priceKRW * 100).toFixed(2);
                
                buyHTML += `
                    <div class="quote-row quote-buy" onclick="selectQuote(${buyPriceKRW})">
                        <div class="quote-row-left">
                            <div class="quote-volume">${volume}</div>
                        </div>
                        <div class="quote-row-right">
                            <div class="quote-price">${buyPriceKRW.toLocaleString()}</div>
                            ${!isKorean(currentStock) ? `<div class="quote-usd">$${buyPriceUSD}</div>` : ''}
                            <div class="quote-change">${changePercent}%</div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('sellQuotes').innerHTML = sellHTML;
            document.getElementById('buyQuotes').innerHTML = buyHTML;
        }

        // í˜¸ê°€ ì„ íƒ
        function selectQuote(price) {
            document.getElementById('limitPriceInput').value = price.toLocaleString();
            updateLimitPrice();
            closeQuoteModal();
        }

        // ê±°ë˜ ëª¨ë‹¬ ì—´ê¸°
        function openTradeModal(type) {
            currentTradeType = type;
            currentPriceType = 'limit';
            
            const modal = document.getElementById('tradeModal');
            const modalTitle = document.getElementById('modalTitle');
            const confirmBtn = document.getElementById('confirmBtn');
            const price = stockData[stockData.length - 1].price;
            
            modalTitle.textContent = type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
            confirmBtn.textContent = type === 'buy' ? 'êµ¬ë§¤í•˜ê¸°' : 'íŒë§¤í•˜ê¸°';
            confirmBtn.className = 'action-btn confirm-btn' + (type === 'sell' ? ' sell' : '');
            
            // ê°€ê²© ë¼ë²¨ ë³€ê²½
            const priceLabelElements = document.querySelectorAll('.price-label');
            if (priceLabelElements.length > 0) {
                priceLabelElements[0].textContent = type === 'buy' ? 'êµ¬ë§¤í•  ê°€ê²©' : 'íŒë§¤í•  ê°€ê²©';
            }
            
            // íƒ­ í…ìŠ¤íŠ¸ ë³€ê²½
            const limitTab = document.querySelector('.price-tab[data-type="limit"]');
            if (limitTab) {
                limitTab.textContent = type === 'buy' ? 'êµ¬ë§¤í•  ê°€ê²©' : 'íŒë§¤í•  ê°€ê²©';
            }
            
            // ìŠ¤íƒ‘ë¡œìŠ¤ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            const stopLossSection = document.getElementById('stopLossSection');
            if (type === 'buy') {
                stopLossSection.style.display = 'block';
                document.getElementById('enableStopLoss').checked = false;
                document.getElementById('stopLossInputArea').style.display = 'none';
                document.getElementById('stopLossPercent').value = 10;
                document.querySelector('input[name="stopLossType"][value="percent"]').checked = true;
            } else {
                stopLossSection.style.display = 'none';
            }
            
            // ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
            updatePriceDisplay(price);
            
            // ë³´ìœ /êµ¬ë§¤ ê°€ëŠ¥ ì •ë³´
            if (type === 'buy') {
                const maxShares = Math.floor(portfolio.cash / price);
                document.getElementById('availableInfo').textContent = `êµ¬ë§¤ ê°€ëŠ¥ ${maxShares.toLocaleString()}ì£¼`;
            } else {
                document.getElementById('availableInfo').textContent = `ë³´ìœ  ${portfolio.shares.toLocaleString()}ì£¼`;
            }
            
            // íƒ­ ì´ˆê¸°í™”
            document.querySelectorAll('.price-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('.price-tab[data-type="limit"]').classList.add('active');
            
            document.getElementById('quantityInput').value = 0;
            
            modal.classList.add('show');
            updateTotalAmount();
        }

        // ê°€ê²© íƒ€ì… ì „í™˜
        function switchPriceTab(type) {
            currentPriceType = type;
            
            document.querySelectorAll('.price-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.price-tab[data-type="${type}"]`).classList.add('active');
            
            // ì½˜í…ì¸  ì „í™˜
            document.getElementById('limitPriceContent').style.display = type === 'limit' ? 'block' : 'none';
            document.getElementById('currentPriceContent').style.display = type === 'current' ? 'block' : 'none';
            document.getElementById('marketPriceContent').style.display = type === 'market' ? 'block' : 'none';
            
            updateTotalAmount();
        }

        // ê°€ê²© ì…ë ¥ í¬ë§·íŒ… (ì½¤ë§ˆ ì¶”ê°€)
        function formatPriceInput(input) {
            // ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^\d]/g, '');
            
            // ìˆ«ìë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜
            let number = parseInt(value) || 0;
            
            // ì½¤ë§ˆ í¬ë§·íŒ…
            input.value = number.toLocaleString();
            
            // ì…ë ¥ í•„ë“œ ë„ˆë¹„ ìë™ ì¡°ì •
            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.fontSize = '2.5em';
            tempSpan.style.fontWeight = 'bold';
            tempSpan.textContent = input.value || '0';
            document.body.appendChild(tempSpan);
            input.style.width = (tempSpan.offsetWidth + 10) + 'px';
            document.body.removeChild(tempSpan);
        }
        
        // ê°€ê²© ì…ë ¥ê°’ì„ ìˆ«ìë¡œ ê°€ì ¸ì˜¤ê¸°
        function getPriceInputValue() {
            const input = document.getElementById('limitPriceInput');
            return parseInt(input.value.replace(/[^\d]/g, '')) || 0;
        }
        
        // ê°€ê²© í‘œì‹œ ì—…ë°ì´íŠ¸
        function updatePriceDisplay(price) {
            const input = document.getElementById('limitPriceInput');
            
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹: ì›ë§Œ í‘œì‹œ
                const priceKRW = Math.round(price);
                input.value = priceKRW.toLocaleString();
            } else {
                // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ ê¸°ì¤€ìœ¼ë¡œ ì›í™” í™˜ì‚°
                const priceUSD = price;
                const priceKRW = Math.round(priceUSD * USD_TO_KRW);
                input.value = priceKRW.toLocaleString();
            }
            
            // ì…ë ¥ í•„ë“œ ë„ˆë¹„ ìë™ ì¡°ì •
            formatPriceInput(input);
            updateLimitPrice();
            
            // í˜„ì¬ê°€ íƒ­
            const displayPrice = isKorean(currentStock) ? 
                'ì•½ ' + Math.round(price).toLocaleString() + 'ì›' :
                'ì•½ ' + Math.round(price * USD_TO_KRW).toLocaleString() + 'ì›';
            document.getElementById('currentPriceKRW').textContent = displayPrice;
            
            // í˜„ì¬ê°€ íƒ­ - ë‹¬ëŸ¬ í‘œì‹œ
            const currentPriceUSDElement = document.getElementById('currentPriceUSD');
            if (isKorean(currentStock)) {
                currentPriceUSDElement.style.display = 'none';
            } else {
                currentPriceUSDElement.textContent = '$' + price.toFixed(2);
                currentPriceUSDElement.style.display = 'block';
            }
        }
        
        // ê°€ê²© ì¡°ì • ë²„íŠ¼ (+/-)
        function adjustPrice(direction) {
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹: ì›í™” ê¸°ì¤€ 100ì› ë‹¨ìœ„
                let currentValue = getPriceInputValue();
                const step = 100;
                currentValue += direction * step;
                if (currentValue < 0) currentValue = 0;
                document.getElementById('limitPriceInput').value = Math.round(currentValue).toLocaleString();
            } else {
                // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ ê¸°ì¤€ $0.01 ë‹¨ìœ„
                const currentKRW = getPriceInputValue();
                const currentUSD = currentKRW / USD_TO_KRW;
                const newUSD = (parseFloat(currentUSD) + (direction * 0.01)).toFixed(2);
                const newKRW = Math.round(parseFloat(newUSD) * USD_TO_KRW);
                document.getElementById('limitPriceInput').value = newKRW.toLocaleString();
            }
            
            updateLimitPrice();
            updateTotalAmount();
        }
        
        // ì§€ì •ê°€ ì…ë ¥ ì‹œ USD ì—…ë°ì´íŠ¸
        function updateLimitPrice() {
            const priceKRW = getPriceInputValue();
            
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹: ë‹¬ëŸ¬ í‘œì‹œ ìˆ¨ê¹€
                document.getElementById('limitPriceUSD').style.display = 'none';
            } else {
                // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ í‘œì‹œ (í™”ì‚´í‘œ ì—†ì´)
                const priceUSD = (priceKRW / USD_TO_KRW).toFixed(2);
                document.getElementById('limitPriceUSD').textContent = '$' + priceUSD;
                document.getElementById('limitPriceUSD').style.display = 'block';
            }
            
            updateTotalAmount();
        }

        // ê±°ë˜ ëª¨ë‹¬ ë‹«ê¸°
        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('show');
        }

        // ë¹ ë¥¸ ìˆ˜ëŸ‰ ì„¤ì •
        function setQuickQuantity(percent) {
            const price = stockData[stockData.length - 1].price;
            
            let maxShares = 0;
            if (currentTradeType === 'buy') {
                // í•œêµ­ ì£¼ì‹: ë‹¬ëŸ¬ë¥¼ ì›í™”ë¡œ í™˜ì‚° í›„ ê³„ì‚°
                if (isKorean(currentStock)) {
                    const cashKRW = portfolio.cash * USD_TO_KRW;
                    maxShares = Math.floor(cashKRW / price);
                } else {
                    // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ ê·¸ëŒ€ë¡œ ê³„ì‚°
                    maxShares = Math.floor(portfolio.cash / price);
                }
            } else {
                maxShares = portfolio.shares;
            }
            
            const shares = Math.floor(maxShares * percent / 100);
            document.getElementById('quantityInput').value = shares;
            updateTotalAmount();
        }

        // ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        function updateTotalAmount() {
            const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
            let priceKRW = 0;
            
            // ê°€ê²© íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ê°€ê²© ì‚¬ìš©
            if (currentPriceType === 'limit') {
                priceKRW = getPriceInputValue();
            } else {
                // í˜„ì¬ê°€ë‚˜ ì‹œì¥ê°€ëŠ” ì‹¤ì œ ì£¼ê°€ ì‚¬ìš©
                const price = stockData[stockData.length - 1].price;
                priceKRW = isKorean(currentStock) ? Math.round(price) : Math.round(price * USD_TO_KRW);
            }
            
            const total = quantity * priceKRW;
            
            document.getElementById('totalAmount').textContent = Math.round(total).toLocaleString() + 'ì›';
        }

        // ê±°ë˜ í™•ì¸
        function confirmTrade() {
            const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
            const price = stockData[stockData.length - 1].price;
            
            if (quantity <= 0) {
                showToast('ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë‹¬ëŸ¬ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (ë‚´ë¶€ ì €ì¥ì€ í•­ìƒ ë‹¬ëŸ¬)
            let totalCostUSD;
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹: ì›í™” ê°€ê²©ì„ ë‹¬ëŸ¬ë¡œ í™˜ì‚°
                totalCostUSD = (price * quantity) / USD_TO_KRW;
            } else {
                // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ ê·¸ëŒ€ë¡œ
                totalCostUSD = price * quantity;
            }
            
            if (currentTradeType === 'buy') {
                if (portfolio.cash < totalCostUSD) {
                    const displayCash = isKorean(currentStock) ? 
                        Math.round(portfolio.cash * USD_TO_KRW).toLocaleString() + 'ì›' :
                        '$' + portfolio.cash.toLocaleString();
                    const displayNeed = isKorean(currentStock) ?
                        Math.round(totalCostUSD * USD_TO_KRW).toLocaleString() + 'ì›' :
                        '$' + totalCostUSD.toLocaleString();
                    showToast('í˜„ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\ní•„ìš”: ' + displayNeed + '\në³´ìœ : ' + displayCash);
                    return;
                }
                
                portfolio.shares += quantity;
                portfolio.cash -= totalCostUSD;
                
                // ë§¤ìˆ˜ê°€ ì €ì¥
                portfolio.buyPrice = isKorean(currentStock) ? price : price * USD_TO_KRW;
                
                // ìŠ¤íƒ‘ë¡œìŠ¤ ì„¤ì • ì €ì¥
                if (document.getElementById('enableStopLoss').checked) {
                    portfolio.stopLoss = getStopLossPrice();
                } else {
                    portfolio.stopLoss = null;
                }
                
                addTrade('buy', quantity, price);
                
                const displayPrice = isKorean(currentStock) ?
                    Math.round(price).toLocaleString() + 'ì›' :
                    '$' + price.toFixed(2);
                    
                showToast('ë§¤ìˆ˜ ì™„ë£Œ!\n' + quantity + 'ì£¼ ' + displayPrice);
            } else {
                if (portfolio.shares < quantity) {
                    showToast('ë³´ìœ  ì£¼ì‹ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\nìš”ì²­: ' + quantity + 'ì£¼\në³´ìœ : ' + portfolio.shares + 'ì£¼');
                    return;
                }
                
                portfolio.shares -= quantity;
                portfolio.cash += totalCostUSD;
                
                // ì „ëŸ‰ ë§¤ë„ ì‹œ ìŠ¤íƒ‘ë¡œìŠ¤ ì´ˆê¸°í™”
                if (portfolio.shares === 0) {
                    portfolio.stopLoss = null;
                    portfolio.buyPrice = null;
                }
                
                addTrade('sell', quantity, price);
                
                const displayPrice = isKorean(currentStock) ?
                    Math.round(price).toLocaleString() + 'ì›' :
                    '$' + price.toFixed(2);
                    
                showToast('ë§¤ë„ ì™„ë£Œ!\n' + quantity + 'ì£¼ ' + displayPrice);
            }
            
            // í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ ì—…ë°ì´íŠ¸ (ë‹¬ëŸ¬ ê¸°ì¤€)
            const currentStockValueUSD = isKorean(currentStock) ?
                (portfolio.shares * price) / USD_TO_KRW :
                portfolio.shares * price;
            portfolio.value = portfolio.cash + currentStockValueUSD;
            
            updateUI();
            closeTradeModal();
        }

        function addTrade(type, shares, price) {
            const formatPrice = isKorean(currentStock) ? 
                Math.round(price).toLocaleString() + 'ì›' : 
                '$' + price.toFixed(2);
            
            // ì£¼ì‹ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            const stockNames = {
                'AAPL': 'Apple',
                'GOOGL': 'Google',
                'MSFT': 'Microsoft',
                'TSLA': 'Tesla',
                'AMZN': 'Amazon',
                'META': 'Meta',
                'NVDA': 'NVIDIA',
                '005930.KS': 'ì‚¼ì„±ì „ì',
                '000660.KS': 'SKí•˜ì´ë‹‰ìŠ¤',
                '035420.KS': 'NAVER',
                '035720.KS': 'ì¹´ì¹´ì˜¤',
                '051910.KS': 'LGí™”í•™',
                '006400.KS': 'ì‚¼ì„±SDI',
                '207940.KS': 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤',
                '005380.KS': 'í˜„ëŒ€ì°¨'
            };
            
            const stockName = stockNames[currentStock] || currentStock;
            
            trades.unshift({
                type: type,
                stockName: stockName,
                symbol: currentStock,
                shares: shares,
                price: price,
                date: new Date().toLocaleString('ko-KR'),
                isKorean: isKorean(currentStock)
            });
            
            const tradeList = document.getElementById('tradeList');
            tradeList.innerHTML = trades.slice(0, 10).map(t => {
                const displayPrice = t.isKorean ? 
                    Math.round(t.price).toLocaleString() + 'ì›' : 
                    '$' + t.price.toFixed(2);
                return `
                    <div class="trade-item ${t.type}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong style="font-size: 1.1em;">${t.type === 'buy' ? 'ğŸŸ¢ ë§¤ìˆ˜' : 'ğŸ”´ ë§¤ë„'}</strong>
                            <span style="opacity: 0.7; font-size: 0.9em;">${t.date}</span>
                        </div>
                        <div style="font-size: 1.05em; font-weight: bold; margin-bottom: 5px;">${t.stockName}</div>
                        <div style="font-size: 1em;">${t.shares}ì£¼ ${displayPrice}</div>
                    </div>
                `;
            }).join('');
        }

        function updateUI() {
            const formatValue = (val) => Math.round(val).toLocaleString();
            const returnPercent = ((portfolio.value - 3000) / 3000 * 100).toFixed(2);
            
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹ - ë‹¬ëŸ¬ë¥¼ ì›í™”ë¡œ í™˜ì‚°
                const portfolioKRW = Math.round(portfolio.value * USD_TO_KRW);
                const cashKRW = Math.round(portfolio.cash * USD_TO_KRW);
                
                document.getElementById('portfolio').textContent = portfolioKRW.toLocaleString() + 'ì›';
                document.getElementById('cash').textContent = cashKRW.toLocaleString() + 'ì›';
                document.getElementById('portfolioKRW').style.display = 'none';
                document.getElementById('cashKRW').style.display = 'none';
            } else {
                // ë¯¸êµ­ ì£¼ì‹ - ë‹¬ëŸ¬ í‘œì‹œ + ì›í™” í™˜ì‚°
                document.getElementById('portfolio').textContent = '$' + formatValue(portfolio.value);
                document.getElementById('cash').textContent = '$' + formatValue(portfolio.cash);
                
                // ì›í™” í™˜ì‚°
                const portfolioKRW = Math.round(portfolio.value * USD_TO_KRW);
                const cashKRW = Math.round(portfolio.cash * USD_TO_KRW);
                document.getElementById('portfolioKRW').textContent = 'â‚©' + portfolioKRW.toLocaleString();
                document.getElementById('cashKRW').textContent = 'â‚©' + cashKRW.toLocaleString();
                document.getElementById('portfolioKRW').style.display = 'block';
                document.getElementById('cashKRW').style.display = 'block';
            }
            
            document.getElementById('shares').textContent = portfolio.shares + 'ì£¼';
            document.getElementById('return').textContent = returnPercent + '%';
            
            const returnCard = document.getElementById('returnCard');
            if (returnPercent >= 0) {
                returnCard.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else {
                returnCard.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function formatPrice(amount) {
            console.log('formatPrice í˜¸ì¶œ:', { amount, currentStock, isKorean: isKorean(currentStock), USD_TO_KRW });
            
            // ë°©ì–´ ì½”ë“œ: amountê°€ ìœ íš¨í•œì§€ í™•ì¸
            if (typeof amount !== 'number' || isNaN(amount)) {
                console.error('formatPrice: ì˜ëª»ëœ ê¸ˆì•¡', amount);
                return '0ì›';
            }
            
            // ì£¼ê°€ëŠ” ì´ë¯¸ í˜„ì§€ í†µí™” (KRW ë˜ëŠ” USD)
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹: ì´ë¯¸ ì›í™”
                return Math.round(amount).toLocaleString() + 'ì›';
            } else {
                // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬
                return '$' + amount.toFixed(2);
            }
        }
        
        function formatCashAmount(amount) {
            console.log('formatCashAmount í˜¸ì¶œ:', { amount, currentStock, isKorean: isKorean(currentStock), USD_TO_KRW });
            
            // í¬íŠ¸í´ë¦¬ì˜¤ ê¸ˆì•¡ì€ í•­ìƒ ë‹¬ëŸ¬ë¡œ ê´€ë¦¬ë¨
            if (isKorean(currentStock)) {
                // í•œêµ­ ì£¼ì‹: ë‹¬ëŸ¬ë¥¼ ì›í™”ë¡œ í™˜ì‚°
                const amountKRW = Math.round(amount * USD_TO_KRW);
                console.log(`ì›í™” í™˜ì‚°: $${amount} Ã— ${USD_TO_KRW} = ${amountKRW}ì›`);
                return amountKRW.toLocaleString() + 'ì›';
            } else {
                // ë¯¸êµ­ ì£¼ì‹: ë‹¬ëŸ¬ í‘œì‹œ
                return '$' + Math.round(amount).toLocaleString();
            }
        }
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.formatPrice = formatPrice;
        window.formatCashAmount = formatCashAmount;

        document.getElementById('stockSelect').addEventListener('change', (e) => {
            currentStock = e.target.value;
            
            // ë°ì´í„° ì´ˆê¸°í™” (ë§¤ìš° ì¤‘ìš”!)
            allStockData = {};
            stockData = [];
            predictionData = [];
            aiRecommendation = null;
            lstmModel = null;
            realtimePrice = 0;
            
            // AI ì¶”ì²œ ìˆ¨ê¸°ê¸°
            document.getElementById('aiRecommendation').classList.remove('show');
            document.getElementById('predictionChart').style.display = 'none';
            
            // ì°¨íŠ¸ ìˆ¨ê¸°ê¸°
            document.getElementById('chart').style.display = 'none';
            document.getElementById('chartLoading').style.display = 'block';
            document.getElementById('chartLoading').innerHTML = '<p>ì¢…ëª©ì„ ì„ íƒí•˜ê³  "ë°ì´í„° ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>';
            
            // ê°€ê²© í‘œì‹œ ìˆ¨ê¸°ê¸°
            document.getElementById('chartPriceDisplay').style.display = 'none';
            
            // ê±°ë˜ ì •ë³´ ìˆ¨ê¸°ê¸°
            document.getElementById('chartInfo').style.display = 'none';
            
            // ê¸°ê°„ íƒ­ ìˆ¨ê¸°ê¸°
            document.getElementById('periodTabs').style.display = 'none';
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('trainBtn').disabled = true;
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('sellBtn').disabled = true;
            
            // ì£¼ì‹ ì •ë³´ ìˆ¨ê¸°ê¸°
            document.getElementById('stockInfo').style.display = 'none';
            
            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
        });

        // ì´ˆê¸° ì‹¤í–‰
        checkServerConnection();
    </script>
</body>
</html>